<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>TheVann Track Duration ‚Äî v8 (Admin/User System)</title>
  <meta name="description" content="Track work time with custom rounding, month view, multi-language, dark/light theme, CSV, print-ready and Google sign-in." />

  <style>
    /* ===================================================
    ORIGINAL DESIGN THEME (STABLE & ORIGINAL STYLE)
    ===================================================
    */
    :root{
      --bg:#071226;--card:#0b1724;--text:#eaf6fb;--muted:#9fb7c6;--accent:#06c2d6;--accent-2:#2dd4bf;--success:#16a34a;--danger:#ef4444;
      --glass:rgba(255,255,255,0.03);--radius:12px;--shadow:0 12px 30px rgba(3,8,20,0.6);--table-border:rgba(255,255,255,0.04);
      --input-bg:rgba(255,255,255,0.04);
      
      --dayoff-bg: rgba(239, 68, 68, 0.15); 
      --dayoff-border: #ef4444;
      --dayoff-text: #ffcfcf;
      
      --earnings-color: #fbbd0a; 
    }
    body.light-mode{
      --bg:#f7fbfc;--card:#fff;--text:#06202a;--muted:#4b5963;--accent:#0ea5a3;--accent-2:#7dd3fc;--glass:rgba(2,6,23,0.03);--shadow:0 8px 20px rgba(2,6,23,0.06);--table-border:rgba(2,6,23,0.06);
      --dayoff-bg: #fff0f0;
      --dayoff-border: #cc3333;
      --dayoff-text: #cc3333;
      --earnings-color: #e38200;
    }
    
    /* General Styles */
    *{box-sizing:border-box; transition: all 0.3s ease-in-out;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Roboto,Arial;padding:14px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.02));padding:16px;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--glass)}
    
    /* HEADER & SIGNED STATE FIX (STABLE MOBILE/DESKTOP) */
    header.app-head{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:8px; position: relative; padding-top: 50px;} 
    .title-wrap{flex:1;min-width:180px; display: flex; align-items: center; gap: 10px;}
    h1.title{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:12px;margin-top:4px; margin-left: 35px;}

    /* AUTH SCREEN (SIMPLIFIED) */
    #auth-area {display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 28px); margin:-14px; padding: 20px;}
    .auth-area .auth-title {font-size: 30px; margin-bottom: 20px;}
    .auth-btn{padding:10px 18px;border-radius:18px;border:none;background:#fff;color:#022;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.25); display: flex; align-items: center; max-width: 280px;}
    
    /* GOOGLE ICON FIX (Base64) */
    .google-icon {
        width: 18px; height: 18px; margin-right: 10px; background-size: contain; background-repeat: no-repeat;
        /* Base64 SVG for the standard Google G Logo */
        background-image: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjNDI4NUY0IiBkPSJNMjQgNWM2LjYgMCAxMC4zIDIuOCAxMi42IDUuM2wtMy43IDMuN2MtMS42LTEuNS0zLjctMi42LTguOS0yLjZtMC04Yy0xMS4yIDAtMTkuOSAxMC4zLTE5LjkgMTAuMy0xLjEgMS0xLjEgMi43IDAgMy44bDIuNiAyLjZjMS4xIDEuMSAxLjEgMi44IDAgMy45bC0xLjYgMS42Yy0xLjEgMS4xLTEuMSAyLjcgMCAzLjhsMy44IDMuOGMxLjEgMS4xIDIuNyAxLjEgMy44IDBsNC4zLTQuM2MxLjEtMS4xIDIuOC0xLjEgMy45IDBsMy44IDMuOGMxLjEgMS4xIDIuNyAxLjEgMy44IDBsNC4zLTQuM2MxLjEtMS4xIDIuOC0xLjEgMy45IDBsMi42LTIuNmMxLjEtMS4xIDEuMS0yLjcgMC0zLjhhLTMuOCAwTDM0LjMgMTkuMWMtMS4xLTEuMS0yLjgtMS4xLTMuOSAwbC0zLjggMy44Yy0xLjEgMS4xLTIuOCAxLjEtMy45IDBsLTQuMy00LjNjLTEuMS0xLjEtMi43LTEuMS0zLjggMEwyMi40IDEyYy0xLjEtMS4xLTIuNy0xLjEtMy44IDBsLTMuOCAzLjhjLTEuMSAxLjEtMi44IDEuMS0zLjkgMGwtMi42LTIuNmMtMS4xLTEuMS0xLjEtMi43IDAtMy44bDMuNy0zLjdjMS41LTMuNSAzLjktNi4zIDYuMy04LjdsMy43LTMuN2MyLjUtMi41IDUuMy0zLjggOC45LTMuOGg3LjJtMTQuMyAyNmMwIDYuMi0yLjUgMTAuMy01LjMgMTIuNmwtMy43IDMuN2MtMS42IDEuNS0zLjcgMi42LTguOSA1LjNoLS4zODE2IDMyLjcuM2wtMy44IDMuOGMtMS4xIDEuMS0yLjggMS4xLTMuOSAwbC0yLjYtMi42Yy0xLjEtMS4xLTEuMS0yLjcgMC0zLjhsMy43LTMuN2MtMS42LTEuNS0zLjctMi42LTguOS01LjNoLTMuOHYtMTkuNWgyLjZjNC4yIDAgNy42IDMgOS40IDYuNUw0MyAyOS42Yy41LjkuNyAxLjguNyAyLjhtLTguMi0zLjVjLS42IDAtMS4yLS4xLTEuNy0uMy0xLjYtLjYtMi41LTEuNS0yLjUtMi41VjI3YzAtMSAuOS0xLjkgMi41LTIuNXYtLjVjMC0uNi0uMy0xLjItLjgtMS43TDM2IDIzLjVjLS41LjUtLjggMS4xLS44IDEuN3YxLjJjMCAuNS4yIDEuMS43IDEuNmw1LjQgNS40YzEuNSAxLjUgMi4yIDMuMyAyLjIgNS44czEuMiA0LjMgMi44IDYuNWwxLjcgMS43Yy45LjkgMi4zIDEuMyAzLjggMS4zVjEzYzAtLjctLjQtMS4zLS45LTEuN2wtMy45LTMuOWMtLjUtLjUtMS4yLS44LTEuNy0uOEgzNGMtLjYgMC0xLjEuMy0xLjcuOGwtMy43IDMuN2MtLjUuNS0uOCAxLjItLjggMS43VjE3YzAgMSAuOSAxLjkgMi41IDIuNXYtLjVjMC0uNi0uMy0xLjItLjgtMS43TDM2IDI0LjNjLS41LjUtLjggMS4xLS44IDEuN3YxLjJjMCAuNS4xIDEuMS43IDEuNmwxLjcgMS43YzkuOS0uNS0uOTQtLjMtMS43LS44LTIuNC0xLjRMOS45IDE2LjdjLS41LjUtMS4yLjgtMS43LjhzPSInIGZpbGw9IiMzQTRFMzkiLz48L3N2Zz4=');
    }
    
    /* SIGNED STATE (FIXED FOR MOBILE/DESKTOP) */
    #signedState {
        display: none;
        position: fixed; /* Fixed position is OK if padding is handled */
        top: 0px; 
        right: 0px;
        padding: 8px 12px;
        background: var(--card);
        border-bottom-left-radius: 12px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        flex-direction: row;
        align-items: center;
        gap: 8px;
        z-index: 1000;
    }
    .signed-as{color:var(--success);font-weight:700;font-size:13px; white-space: nowrap;}
    .auth-btn.secondary{
      background:var(--danger); 
      color: #fff; 
      border: 1px solid var(--danger); 
      padding: 4px 8px; 
      font-size: 12px;
      margin-bottom: 0;
    }

    /* language + theme */
    .right-controls{display:flex;align-items:center;gap:8px}
    .lang-select{display:flex;gap:6px}
    .lang-select button{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:8px;color:var(--text);cursor:pointer;font-size:13px}
    .toggle{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:8px;cursor:pointer}

    /* inputs / controls */
    .controls-top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:12px}
    .entry-grid{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .input-group label {color: var(--muted);font-size: 12px;font-weight: 600;text-transform: uppercase;margin-left: 0;}
    .input-group {display: flex;flex-direction: column;gap: 0;}
    input[type=date],input[type=time],input[type=text],input[type=number]{background:transparent;border:1px solid var(--table-border);padding:8px 10px;border-radius:8px;color:var(--text);min-width:120px}
    .preview{color:var(--muted);font-size:13px}

    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022}
    .ghost{background:transparent;border:1px solid var(--table-border);color:var(--text)}

    /* table */
    .table-wrap{overflow:auto;margin-top:14px;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:700px}
    thead th{padding:10px 12px;text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;border-bottom:1px solid var(--table-border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--table-border)}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}
    
    /* DAY OFF Style */
    tr.day-off {background: var(--dayoff-bg) !important; color: var(--dayoff-text) !important;font-weight: 600; border: 1px solid var(--dayoff-border) !important;}
    tr.day-off td {font-style: italic; border-bottom: 1px solid var(--dayoff-border) !important;padding: 10px 12px;}
    tr.day-off td:first-child::before {content: "üö® "; margin-right: 5px;}

    .actions{display:flex;gap:8px}
    .chip{padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .chip.edit{background:var(--success);color:#fff}
    .chip.del{background:var(--danger);color:#fff}

    .footer{display:flex;justify-content:flex-end;margin-top:12px; display: none;} 
    .total-card{background:var(--input-bg);padding:10px 15px;border-radius:8px;color:var(--text);font-weight:700; font-size: 15px;}
    .total-card span { color: var(--accent); font-size: 16px;}
    
    /* NEW: Earnings Display */
    #earnings-display {background: var(--input-bg);padding: 10px 15px;border-radius: 8px;color: var(--text);font-weight: 700;font-size: 15px;border: 1px solid var(--table-border);}
    #earnings-display span {color: var(--earnings-color);font-size: 16px;font-weight: 800;}
    .controls-top .earnings-wrapper {order: 3; margin-left: 8px;}
    
    /* ADMIN VIEW SPECIFIC STYLES */
    #admin-dashboard-view {display: none; }
    #admin-dashboard-view table { min-width: 900px; }
    #admin-dashboard-view h2 { color: var(--accent); margin-top: 0; }
    #admin-totals-table th, #admin-totals-table td { text-align: left; padding: 10px; border-bottom: 1px solid var(--table-border);}
    #admin-pass-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 3000; display: none; justify-content: center; align-items: center;}
    #admin-pass-form-card { background: var(--card); padding: 30px; border-radius: var(--radius); width: 90%; max-width: 350px; text-align: center; }

    /* MOBILE FIXES */
    @media(max-width:640px){
      header.app-head { padding-top: 50px; }
      #signedState {position: fixed; top: 0; left: 0; width: 100%; border-radius: 0; border-bottom: 1px solid var(--table-border); box-shadow: 0 1px 5px rgba(0,0,0,0.2); justify-content: flex-end; }
      .controls-top{flex-direction:column; align-items:stretch; gap: 8px;}
      .total-card { order: 1; margin-bottom: 5px; } 
      .controls-top .earnings-wrapper { order: 2; margin-left: 0; margin-bottom: 5px; width: 100%;} 
      .controls-top div:last-child { order: 3; margin-left: 0 !important; }
      input[type=date],input[type=time],input[type=text],input[type=number],.btn,.total-card, #earnings-display{width:100%; min-width: unset;}
    }

  </style>
</head>
<body>
  <div class="wrap">
    
<div class="auth-area" id="auth-area" style="display:none;">
      <h1 class="auth-title">Log into TheVann</h1>
      
    <div class="auth-buttons-wrapper">
      
      <button id="googleSignIn" class="auth-btn">
        <div class="google-icon"></div> 
        Continue with Google
      </button>

    </div>

      <p class="auth-terms">
        Data is synced to the cloud via your Google Account.
        <span style="color:var(--accent); font-weight: 600;">Access requires Google Sign-in.</span>
      </p>

</div>
    
    <div id="username-modal" style="display:none;">
        <div id="username-form-card" class="card">
            <h3 id="modal-title">Set Your Display Name</h3>
            <p id="modal-subtitle" style="color:var(--muted); font-size: 14px;">This name will be used in reports.</p>
            <input id="username-input-field" type="text" placeholder="Your Name or Alias" required style="width: 100%; margin-bottom: 15px;" />
            <button id="save-username-btn" class="primary btn" style="width: 100%;">Save Name</button>
        </div>
    </div>
    <div id="admin-pass-modal" style="display:none;">
        <div id="admin-pass-form-card" class="card">
            <h3>Admin Access Required</h3>
            <p style="color:var(--danger); font-size: 14px;">Enter the Admin Password to view User Tracking Data.</p>
            <input id="admin-password-field" type="password" placeholder="Password" required />
            <button id="confirm-admin-pass" class="primary btn" style="margin-top: 15px; width: 100%;">Confirm</button>
        </div>
    </div>
    <div id="loading-screen" class="card" style="display:none;">
        <h2 style="margin-top:0;">‚è≥ Loading...</h2>
        <p style="color:var(--muted);">Checking authentication status...</p>
    </div>

    <div class="card" id="app-content" style="display:none;" role="application" aria-labelledby="app-title">
      
      <header class="app-head">
        
        <div id="signedState" style="display:none;">
            <div class="signed-as" id="signedText"></div>
            <button id="signOut" class="auth-btn secondary"></button>
        </div>
        <div class="title-wrap">
          <h1 class="title" id="app-title">TheVann Track Duration</h1>
          <div class="subtitle" id="app-sub">Auto rounding, monthly view, multi-language</div>
        </div>

        <div class="right-controls">
          <button id="admin-menu-btn" class="ghost btn" style="display:none;">Admin Dashboard</button>
          <div class="lang-select" id="lang-buttons" role="tablist" aria-label="Language selector">
            <button data-lang="en">üá∫üá∏ EN</button>
            <button data-lang="my">üá≤üá≤ ·Äª·Äô·Äî·Äπ·Äô·Ä¨</button>
            <button data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="toggle" id="theme-toggle" title="Toggle theme">üåô</div>
          </div>
        </div>
      </header>

      <div class="controls-top">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prev-month" class="ghost btn">‚óÄ</button>
          <div id="month-label" style="font-weight:700;min-width:160px;text-align:center;">Month</div>
          <button id="next-month" class="ghost btn">‚ñ∂</button>
          <button id="today-month" class="ghost btn">üóìÔ∏è Today</button>
        </div>
        
        <div class="total-card" id="total-header">Total Rounded Hours: <span id="total">0.00</span></div>
        
        <div class="earnings-wrapper">
            <div id="earnings-display"><span id="earnings-label-text">·Äõ·Äõ·Äæ·Ä≠·Äô·Ää·Ä∑·Ä∫·ÄÑ·ÄΩ·Ä±</span>: <span id="earnings-amount">0.00 ‡∏ø</span></div>
        </div>
        
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="export-csv" class="ghost btn">üíæ Export CSV</button>
          <button id="print-btn" class="ghost btn">üñ®Ô∏è Print</button>
        </div>
      </div>

      <div class="entry-grid" style="margin-top:12px">
        <div class="input-group">
            <label id="date-label" for="date-input">Date</label>
            <input id="date-input" type="date" />
        </div>
        
        <div class="input-group">
            <label id="start-label" for="start-input">IN</label>
            <input id="start-input" type="time" />
        </div>
        
        <div class="input-group">
            <label id="end-label" for="end-input">OUT</label>
            <input id="end-input" type="time" />
        </div>
        
        <div class="input-group">
            <label id="loan-label" for="loan-input">ADVANCE / LOAN (‡∏ø)</label>
            <input id="loan-input" type="number" placeholder="0" value="0" min="0" />
        </div>
        
        <div class="input-group" style="flex-grow: 1;">
            <label id="task-label" for="task-input">Task / notes (optional)</label>
            <input id="task-input" type="text" placeholder="" />
        </div>
        
        <div class="preview" id="preview" style="align-self: flex-end;">Duration: 00:00 (0.00h)</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="add-btn" class="primary btn">‚ûï Add Entry</button>
          <button id="dayoff-btn" class="ghost btn">üèñÔ∏è Day Off</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="entries-table" aria-describedby="month-label">
          <thead>
            <tr>
              <th>Date</th>
              <th>Start</th>
              <th>End</th>
              <th>Duration (H:M)</th>
              <th>Rounded (hrs)</th>
              <th>Task</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="entries-body"></tbody>
        </table>
      </div>
    </div>
    
    <div class="card" id="admin-dashboard-view" style="display:none;">
        <h2>Admin Dashboard - All Users' Total Hours</h2>
        <div class="table-wrap">
            <table id="admin-totals-table">
                <thead>
                    <tr>
                        <th>User Name (ID)</th>
                        <th>Total Hours</th>
                        <th>Advance/Loan (‡∏ø)</th>
                        <th>Net Earnings (‡∏ø)</th>
                    </tr>
                </thead>
                <tbody id="admin-totals-body">
                    <tr><td colspan="4" style="text-align:center;">Loading user data...</td></tr>
                </tbody>
            </table>
        </div>
        <button id="back-to-user-btn" class="ghost btn" style="margin-top: 15px;">‚¨ÖÔ∏è Back to My Tracker</button>
    </div>
    </div>

  <script type="module">
  // --- Firebase imports (modular) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  
  // --- CONFIGURATION CONSTANTS (FIXED) ---
  const ADMIN_EMAIL = 'vnoon698@gmail.com'; 
  const ADMIN_PASSWORD = '@Vannoon8800'; 
  const HOURLY_RATE = 40.00; // 40 Baht per hour
  
  const firebaseConfig = {
    apiKey: "AIzaSyBPt8cZMMW6gs8TLV-7EEvpJJVZ33DH23k",
    authDomain: "thevanntrackduration-81ee0.firebaseapp.com",
    projectId: "thevanntrackduration-81ee0",
    storageBucket: "thevanntrackduration-81ee0.firebasestorage.app",
    messagingSenderId: "56786707859",
    appId: "1:56786707859:web:75be757ceb95604984f466",
    measurementId: "G-QNG2F09LWL"
  };

  // init firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // --- CONSTANTS ---
  const USER_DATA_COLLECTION = 'users_data'; 
  const ENTRIES_COLLECTION = 'user_entries'; 

  // --- DOM ---
  const googleSignInBtn = document.getElementById('googleSignIn');
  const signedState = document.getElementById('signedState');
  const signedText = document.getElementById('signedText');
  const signOutBtn = document.getElementById('signOut');
  const adminMenuBtn = document.getElementById('admin-menu-btn');
  
  // Modals/Views
  const usernameModal = document.getElementById('username-modal');
  const usernameInputField = document.getElementById('username-input-field');
  const saveUsernameBtn = document.getElementById('save-username-btn');
  const adminPassModal = document.getElementById('admin-pass-modal');
  const adminPasswordField = document.getElementById('admin-password-field');
  const confirmAdminPass = document.getElementById('confirm-admin-pass');
  const adminDashboardView = document.getElementById('admin-dashboard-view');
  const backToUserBtn = document.getElementById('back-to-user-btn');
  const adminTotalsBody = document.getElementById('admin-totals-body');


  const appContent = document.getElementById('app-content');
  const loadingScreen = document.getElementById('loading-screen');
  const authArea = document.getElementById('auth-area'); 

  const dateEl = document.getElementById('date-input');
  const startEl = document.getElementById('start-input');
  const endEl = document.getElementById('end-input');
  const loanEl = document.getElementById('loan-input'); // NEW LOAN INPUT
  const taskEl = document.getElementById('task-input');
  const previewEl = document.getElementById('preview');
  const addBtn = document.getElementById('add-btn');
  const dayOffBtn = document.getElementById('dayoff-btn');
  const entriesBody = document.getElementById('entries-body');
  
  const totalHeaderEl = document.getElementById('total-header'); 
  const totalEl = totalHeaderEl.querySelector('#total'); 
  const earningsDisplay = document.getElementById('earnings-display');
  const earningsAmount = document.getElementById('earnings-amount');
  
  const monthLabel = document.getElementById('month-label');
  const langButtons = document.getElementById('lang-buttons');

  const dateLabel = document.getElementById('date-label');
  const startLabel = document.getElementById('start-label');
  const endLabel = document.getElementById('end-label');
  const taskLabel = document.getElementById('task-label');
  const loanLabel = document.getElementById('loan-label');


  // keys
  const STORAGE = 'vann_v8_entries';
  const THEME = 'vann_v8_theme';
  const LANG = 'vann_v8_lang';
  const MONTH = 'vann_v8_month';

  // translations (FINAL VERSION)
  const translations = {
    en: { 
      app_title:'TheVann Track Duration', sub:'Auto rounding, monthly view, multi-language', add_entry:'Add Entry', add_dayoff:'Day Off', export_csv:'Export CSV', print:'Print', duration_default:'Duration: 00:00 (0.00h)', total_label:'Total Rounded Hours', alert_fill:'Please fill Date, Start and End.', 
      edit: '‚úèÔ∏è Edit', del: 'üóëÔ∏è Delete', day_off_text: 'Day Off',
      date_label: 'Date', in_label: 'IN', out_label: 'OUT', loan_label: 'ADVANCE / LOAN (‡∏ø)', task_placeholder: 'Task / notes (optional)',
      csv_user_label: 'User Name',
      modal_title: 'Set Your Display Name',
      modal_subtitle: 'This name will be used in reports.',
      save_name: 'Save Name',
      sign_out_btn: 'Sign out',
      earnings_label: 'Net Earnings',
      currency: '‡∏ø',
      admin_dashboard: 'Admin Dashboard',
      back_to_user: '‚¨ÖÔ∏è Back to My Tracker',
      admin_access_title: 'Admin Access Required',
      admin_access_prompt: 'Enter the Admin Password to view User Tracking Data.'
    },
    my: { 
      app_title:'Thevann ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏', 
      sub:'·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Äê·Ä∫·Äú·Ää·Ä∫·ÄÖ·ÄÆ·ÄÖ·ÄÖ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Åä ·Äú·ÄÖ·Äâ·Ä∫ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·Äô·Äæ·ÄØ·Åä ·Äò·Ä¨·Äû·Ä¨·ÄÖ·ÄÄ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏', 
      add_entry:'·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫', 
      add_dayoff:'·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫', 
      export_csv:'CSV ·Äë·ÄØ·Äê·Ä∫·Äö·Ä∞·Äô·Ää·Ä∫', 
      print:'·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫', 
      duration_default:'·ÄÄ·Äº·Ä¨·ÄÅ·Äª·Ä≠·Äî·Ä∫: 00:00 (0.00·Äî·Ä¨·Äõ·ÄÆ)', 
      total_label:'·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äï·Äê·Ä∫·Äú·Ää·Ä∫·Äî·Ä¨·Äõ·ÄÆ', 
      alert_fill:'·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤·Åä ·ÄÖ·Äê·ÄÑ·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã',
      edit: '‚úèÔ∏è ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫', del: 'üóëÔ∏è ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫', day_off_text: '·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫',
      date_label: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', in_label: '·Äù·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', out_label: '·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', loan_label: '·ÄÅ·Äª·Ä±·Ä∏·ÄÑ·ÄΩ·Ä± / ·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä± (·ÄÄ·Äª·Äï·Ä∫)', task_placeholder: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ (·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Äú·Ä≠·ÄØ·Äï·Ä´)',
      csv_user_label: '·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Ä°·Äô·Ää·Ä∫',
      modal_title: '·Äô·Ä≠·Äô·Ä≠·Ä°·Äô·Ää·Ä∫ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Ä´',
      modal_subtitle: '·Ä§·Ä°·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·ÄÆ·Äõ·ÄÑ·Ä∫·ÄÅ·Ä∂·ÄÖ·Ä¨·Äô·Äª·Ä¨·Ä∏·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äô·Ää·Ä∫·Åã',
      save_name: '·Ä°·Äô·Ää·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫',
      sign_out_btn: '·Äë·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫',
      earnings_label: '·Äõ·Äõ·Äæ·Ä≠·Äô·Ää·Ä∑·Ä∫·ÄÑ·ÄΩ·Ä± (·Ä°·Äû·Ä¨·Ä∏·Äê·ÄÑ·Ä∫)',
      currency: '·ÄÄ·Äª·Äï·Ä∫',
      admin_dashboard: 'Admin Dashboard',
      back_to_user: '‚¨ÖÔ∏è Tracker ·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Ää·Ä∫',
      admin_access_title: 'Admin ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ää·Ä∫',
      admin_access_prompt: 'Users Tracking Data ·ÄÄ·Ä≠·ÄØ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫ Admin Password ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã'
    },
    th: { 
      app_title:'‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ß‡∏ô', sub:'‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏î‡∏π‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤', add_entry:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', add_dayoff:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', export_csv:'‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV', print:'‡∏û‡∏¥‡∏°‡∏û‡πå', duration_default:'‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: 00:00 (0.00 ‡∏ä‡∏°.)', total_label:'‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©', alert_fill:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å',
      edit: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', del: 'üóëÔ∏è ‡∏•‡∏ö', day_off_text: '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î',
      date_label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', in_label: '‡πÄ‡∏Ç‡πâ‡∏≤', out_label: '‡∏≠‡∏≠‡∏Å', loan_label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ø)', task_placeholder: '‡∏á‡∏≤‡∏ô / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)',
      csv_user_label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
      modal_title: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•',
      modal_subtitle: '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
      save_name: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠',
      sign_out_btn: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
      earnings_label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
      currency: '‡∏ø',
      admin_dashboard: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•',
      back_to_user: '‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°',
      admin_access_title: '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•',
      admin_access_prompt: '‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
    }
  };

  // state
  let entries = [];
  let editId = null;
  let selectedYear, selectedMonth;
  let currentLang = localStorage.getItem(LANG) || 'en';
  let currentUser = null; 
  let isUserAdmin = false; 
  let currentLoanAmount = 0.00; 
  let userCustomName = 'User'; // Global variable for current user's custom name


  // helpers
  function parseHM(t){ if(!t) return null; const [h,m]=t.split(':').map(Number); if(Number.isNaN(h)||Number.isNaN(m)) return null; return h*60+m; }
  function fmtHM(min){ const h=Math.floor(min/60); const m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` }
  
  function computeRounded(raw){ 
    if(raw<=0) return 0.00; 
    const h=Math.floor(raw/60); 
    const m=raw%60; 
    let H=h; 
    
    if(m>=0 && m<=29) {
        return +(H).toFixed(2);
    } 
    else if(m>=30 && m<=39) {
        return +(H + 0.5).toFixed(2); 
    } 
    else if(m>=40 && m<=59){ 
        return +(H + 1).toFixed(2);
    }
    
    return +(H).toFixed(2);
  }

  // --- Firestore Data Handlers (UPDATED for multi-user structure) ---

  // Get user's profile data (name, loan) from Firestore
  async function getUserProfileData(uid) {
      if (!uid) return { customName: 'Guest', loan: 0.00 };
      try {
          const docRef = doc(db, USER_DATA_COLLECTION, uid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
              const data = docSnap.data();
              return { 
                  customName: data.customName || currentUser.displayName || 'User',
                  loan: parseFloat(data.loan) || 0.00
              };
          }
          return { customName: currentUser.displayName || 'User', loan: 0.00 };
      } catch (err) {
          console.error("Error fetching user profile:", err);
          return { customName: currentUser.displayName || 'User', loan: 0.00 };
      }
  }

  // Update user's loan data
  async function saveLoanData(uid, newLoanAmount) {
      if (!uid) return;
      try {
          const docRef = doc(db, USER_DATA_COLLECTION, uid);
          await setDoc(docRef, { loan: parseFloat(newLoanAmount) }, { merge: true });
          currentLoanAmount = parseFloat(newLoanAmount);
          render();
      } catch (err) {
          console.error("Error saving loan data:", err);
          alert("Failed to save loan amount.");
      }
  }


  // Save user's entries 
  async function saveToFirestore(uid){
    if(!uid) return;
    try{
      const d = doc(db, ENTRIES_COLLECTION, uid);
      await setDoc(d, { entries }, { merge: true });
    }catch(err){
      console.error('saveToFirestore error:', err);
    }
  }

  // Load user's entries
  async function loadUserEntries(uid){
    if(!uid) return null;
    try{
      const d = doc(db, ENTRIES_COLLECTION, uid);
      const snap = await getDoc(d);
      if(snap.exists()){
        const data = snap.data();
        return Array.isArray(data.entries) ? data.entries : [];
      } else {
        return [];
      }
    }catch(err){
      console.error('loadUserEntries error:', err);
      return null;
    }
  }

  // --- USER NAME HANDLING ---
  
  saveUsernameBtn.addEventListener('click', async () => {
      const newName = usernameInputField.value.trim();
      if (!newName) {
          alert('Please enter a name.');
          return;
      }
      if (currentUser) {
          try {
              // 1. Save custom name and initial loan (0) to Firestore
              const docRef = doc(db, USER_DATA_COLLECTION, currentUser.uid);
              await setDoc(docRef, { customName: newName, loan: 0.00 });
              
              // 2. Update Firebase Auth profile to hold the new name
              await updateProfile(currentUser, { displayName: newName });

              // 3. Close modal and proceed
              usernameModal.style.display = 'none';
              handleUserSignedIn(currentUser); 
          } catch (error) {
              alert('Failed to save name: ' + error.message);
          }
      }
  });


  // --- ADMIN/USER VIEW LOGIC ---

  function showUserAppView() {
      adminDashboardView.style.display = 'none';
      appContent.style.display = 'block';
  }
  
  // ADMIN DASHBOARD RENDERING (Only visible to Admin)
  async function renderAdminDashboard() {
      appContent.style.display = 'none';
      adminDashboardView.style.display = 'block';
      adminTotalsBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Fetching All User Data...</td></tr>';

      try {
          // 1. Fetch ALL users' profile data (names and loans)
          const usersSnapshot = await getDocs(collection(db, USER_DATA_COLLECTION));
          let allUsersData = {};
          usersSnapshot.forEach(doc => {
              allUsersData[doc.id] = { ...doc.data(), uid: doc.id, totalHours: 0 };
          });

          // 2. Fetch ALL users' time entries and calculate hours
          const entriesSnapshot = await getDocs(collection(db, ENTRIES_COLLECTION));
          entriesSnapshot.forEach(doc => {
              const uid = doc.id;
              const userEntries = doc.data().entries || [];
              
              let totalRoundedHours = 0;
              userEntries.forEach(entry => {
                  totalRoundedHours += entry.rounded || 0;
              });
              
              if (allUsersData[uid]) {
                  allUsersData[uid].totalHours = totalRoundedHours;
              }
          });

          // 3. Render the table
          adminTotalsBody.innerHTML = '';
          const sortedUsers = Object.values(allUsersData).sort((a, b) => a.customName.localeCompare(b.customName));

          if (sortedUsers.length === 0) {
              adminTotalsBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No users found in database.</td></tr>';
              return;
          }

          sortedUsers.forEach(user => {
              const grossEarnings = user.totalHours * HOURLY_RATE;
              const netEarnings = grossEarnings - (user.loan || 0);
              const currency = translations[currentLang].currency || '‡∏ø';
              
              adminTotalsBody.innerHTML += `
                  <tr>
                      <td>${user.customName} <br><span style="font-size:10px; color:var(--muted);">${user.uid.substring(0, 8)}...</span></td>
                      <td>${user.totalHours.toFixed(2)} hrs</td>
                      <td>${(user.loan || 0).toFixed(2)} ${currency}</td>
                      <td style="font-weight:700; color: ${netEarnings < 0 ? 'var(--danger)' : 'var(--success)'}">${netEarnings.toFixed(2)} ${currency}</td>
                  </tr>
              `;
          });
      } catch (error) {
          adminTotalsBody.innerHTML = `<tr class="day-off"><td colspan="4" style="text-align:center;">Error loading data: ${error.message}</td></tr>`;
      }
  }

  // Admin Access Button Handlers
  adminMenuBtn.addEventListener('click', () => {
      adminPassModal.style.display = 'flex';
      adminPasswordField.value = '';
      
      // Update modal texts
      const t = translations[currentLang];
      document.querySelector('#admin-pass-form-card h3').textContent = t.admin_access_title;
      document.querySelector('#admin-pass-form-card p').textContent = t.admin_access_prompt;
      document.getElementById('confirm-admin-pass').textContent = 'Confirm';
  });
  
  confirmAdminPass.addEventListener('click', () => {
      if (adminPasswordField.value === ADMIN_PASSWORD) {
          adminPassModal.style.display = 'none';
          renderAdminDashboard();
      } else {
          alert('Invalid Admin Password!');
          adminPasswordField.value = '';
      }
  });

  backToUserBtn.addEventListener('click', showUserAppView);

  // --- CORE AUTH LOGIC ---

  function showLoadingState(){
      authArea.style.display = 'none'; 
      appContent.style.display = 'none'; 
      signedState.style.display = 'none'; 
      usernameModal.style.display = 'none'; 
      adminPassModal.style.display = 'none';
      loadingScreen.style.display = 'block'; 
      loadingScreen.querySelector('h2').innerHTML = '‚è≥ Loading...';
      loadingScreen.querySelector('p').textContent = 'Checking authentication status...';
  }

  async function handleUserSignedIn(user){
    currentUser = user;
    const uid = user.uid;
    
    // 1. Get User Profile Data (Name and Loan)
    const profile = await getUserProfileData(uid);
    userCustomName = profile.customName;
    currentLoanAmount = profile.loan; 
    
    // 2. Check for Custom Name (If no custom name, prompt the user)
    // We check if the saved name is just the email, which indicates first time login
    if (!profile.customName || profile.customName.includes('@') || profile.customName === 'User') {
        await handleUsernameSetup(user);
        return; 
    }
    
    // Set Admin flag
    isUserAdmin = (user.email === ADMIN_EMAIL);
    adminMenuBtn.style.display = isUserAdmin ? 'block' : 'none';

    signedText.textContent = `Signed in: ${userCustomName}`;
    signedState.style.display = 'flex'; 
    authArea.style.display = 'none'; 
    appContent.style.display = 'block';
    loadingScreen.style.display = 'none';

    // 3. Load user's entries
    const cloudEntries = await loadUserEntries(uid);
    if (cloudEntries) {
        entries = cloudEntries;
    } else {
        entries = [];
    }
    
    render();
  }

  function handleUserSignedOut(){
    currentUser = null;
    isUserAdmin = false;
    adminMenuBtn.style.display = 'none';
    currentLoanAmount = 0.00;

    signedState.style.display = 'none'; 
    usernameModal.style.display = 'none'; 
    adminPassModal.style.display = 'none';
    authArea.style.display = 'flex'; 
    
    appContent.style.display = 'none';
    loadingScreen.style.display = 'none'; 

    // *** THE FIX: Clear only the user's data from local storage on sign-out ***
    localStorage.removeItem(STORAGE); 
    
    render(); 
  }

  // auth events
  onAuthStateChanged(auth, async (user) => {
    if(user){
      await handleUserSignedIn(user);
    } else {
      await handleUserSignedOut();
    }
  });

  // sign in/out UI
  googleSignInBtn.addEventListener('click', async ()=>{
    showLoadingState(); 
    try{
      await signInWithPopup(auth, provider);
    }catch(err){
      alert('Google sign-in failed: ' + err.message);
      handleUserSignedOut(); 
    }
  });
  
  signOutBtn.addEventListener('click', async ()=>{
    try{
      await signOut(auth);
    }catch(err){
      console.error(err);
    }
  });


  // --- USER APP FUNCTIONALITY ---

  // preview update
  function updatePreview(){ 
    const s=startEl.value, e=endEl.value; 
    if(s && e){ 
        const sM=parseHM(s), eM=parseHM(e); 
        if(sM==null||eM==null){ 
            previewEl.textContent = translations[currentLang].duration_default; return; 
        } 
        let diff=eM - sM; 
        if(diff<0) diff+=24*60; 
        previewEl.textContent = `Duration: ${fmtHM(diff)} (${computeRounded(diff).toFixed(2)}h)` 
    } else { 
        previewEl.textContent = translations[currentLang].duration_default 
    } 
  }
  [startEl,endEl].forEach(i=>i.addEventListener('input', updatePreview));

  // render
  function render(){
    entriesBody.innerHTML = '';
    let total = 0;
    const filtered = entries.filter(r=>{
      const d = new Date(r.date);
      return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth;
    });

    filtered.sort((a,b)=> a.date < b.date ? 1 : a.date > b.date ? -1 : b.id - a.id);
    
    const t = translations[currentLang]; 
    const dayOffText = t.day_off_text || 'Day Off';

    for(const row of filtered){
      const tr = document.createElement('tr');
      if(row.isDayOff) tr.classList.add('day-off');
      const start = row.isDayOff? dayOffText : row.start;
      const end = row.isDayOff? dayOffText : row.end;
      const duration = row.isDayOff? dayOffText : row.duration;
      const rounded = row.isDayOff? 0 : row.rounded;
      const taskDisplay = row.isDayOff ? dayOffText : row.task || '';

      tr.innerHTML = `
        <td>${row.date}</td>
        <td>${start}</td>
        <td>${end}</td>
        <td>${duration}</td>
        <td>${rounded.toFixed(2)}</td>
        <td class="${row.isDayOff? 'day-off-task':''}">${taskDisplay}</td>
        <td class="actions">${row.isDayOff? `<button class="chip del" data-id="${row.id}">${t.del}</button>` : `<button class="chip edit" data-id="${row.id}">${t.edit}</button><button class="chip del" data-id="${row.id}">${t.del}</button>`}</td>
      `;
      entriesBody.appendChild(tr);
      total += rounded;
    }

    totalEl.textContent = total.toFixed(2);
    
    // *** CALCULATE EARNINGS WITH LOAN DEDUCTION ***
    const grossEarnings = parseFloat(totalEl.textContent) * HOURLY_RATE;
    const netEarnings = grossEarnings - currentLoanAmount;

    earningsAmount.textContent = `${netEarnings.toFixed(2)} ${t.currency}`;
    earningsDisplay.querySelector('span').style.color = netEarnings < 0 ? 'var(--danger)' : 'var(--earnings-color)';
    // **********************************************
    
    // FIXED: Ensure month name displays correctly using the appropriate locale format
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang] || 'en-US';
    monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    
    applyLanguageTexts();
  }

  // save local + cloud (if signed)
  async function saveAll(){
    saveLocal();
    if(currentUser){
      await saveToFirestore(currentUser.uid);
    }
  }

  // add/update (Loan field added)
  addBtn.addEventListener('click', async ()=>{
    const date = dateEl.value; const s = startEl.value; const e = endEl.value; 
    const loan = parseFloat(loanEl.value) || 0; // Get Loan/Advance amount
    const task = taskEl.value.trim();
    
    if(!date || !s || !e) return alert(translations[currentLang].alert_fill);
    
    const sM = parseHM(s), eM = parseHM(e);
    if(sM==null||eM==null) return alert('Invalid time');
    
    let diff = eM - sM; if(diff<0) diff += 24*60;
    const formatted = fmtHM(diff); const rounded = computeRounded(diff);

    // Save Loan/Advance as an entry (for tracking/editing)
    if(loan > 0) {
        // Update user's loan data in Firestore
        await saveLoanData(currentUser.uid, loan);
    }
    
    if(editId){
      const idx = entries.findIndex(x=>x.id===editId);
      // NOTE: Loan entry logic is simplified; Loan amount is stored separately in profile.
      if(idx>-1){ entries[idx] = { id: editId, date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false }; editId = null; addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; }
    } else {
      entries.push({ id: Date.now(), date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false });
    }
    formReset();
    await saveAll();
  });

  function formReset(){ 
    const now = new Date(); 
    dateEl.valueAsDate = new Date(selectedYear, selectedMonth, Math.min(new Date().getDate(),28)); 
    startEl.value=''; 
    endEl.value=''; 
    loanEl.value='0'; // Reset loan field
    taskEl.value=''; 
    taskEl.placeholder = translations[currentLang].task_placeholder;
    previewEl.textContent = translations[currentLang].duration_default; 
    addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; 
    editId = null; 
  }

  // day off
  dayOffBtn.addEventListener('click', async ()=>{
    const date = dateEl.value; if(!date) return alert(translations[currentLang].alert_fill);
    const dayOffText = translations[currentLang].day_off_text || 'Day Off';
    
    const existingDayOff = entries.some(x => x.date === date && x.isDayOff);

    if (existingDayOff) {
        entries = entries.filter(x => !(x.date === date && x.isDayOff));
        entries = entries.filter(x => x.date !== date);
    } else {
        const regularEntries = entries.filter(x => x.date === date && !x.isDayOff);
        if (regularEntries.length > 0 && !confirm(`There are ${regularEntries.length} regular entries on ${date}. Do you want to delete them and mark this day as Day Off?`)) {
            return;
        }
        
        entries = entries.filter(x => x.date !== date);

        entries.push({ id: Date.now(), date, start:'', end:'', duration:'00:00', rounded:0, loan: 0, task: dayOffText, isDayOff:true });
    }

    formReset(); 
    await saveAll();
  });

  // edit/delete delegation
  entriesBody.addEventListener('click', async (ev)=>{
    const idStr = ev.target.getAttribute('data-id'); 
    if(!idStr) return; 
    const id = Number(idStr);
    const t = translations[currentLang];

    if(ev.target.classList.contains('del')){ 
      if(!confirm('Delete this entry?')) return; 
      entries = entries.filter(x=>x.id!==id); 
      await saveAll(); 
    }
    if(ev.target.classList.contains('edit')){ 
      const idx = entries.findIndex(x=>x.id===id); 
      if(idx===-1) return; 
      const r = entries[idx]; 
      if(r.isDayOff) return alert('Day Off entries cannot be edited directly.'); 
      dateEl.value = r.date; 
      startEl.value = r.start; 
      endEl.value = r.end; 
      loanEl.value = currentLoanAmount.toFixed(2); // Show current loan in form
      taskEl.value = r.task; 
      editId = id; 
      addBtn.textContent = 'üíæ Save'; 
      updatePreview();
      window.scrollTo({top:0,behavior:'smooth'}); 
    }
  });

  // export CSV for current month
  exportBtn.addEventListener('click', ()=>{
    const filtered = entries.filter(r=>{ const d=new Date(r.date); return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth; });
    if(filtered.length===0) return alert('No data to export for this month');
    
    const t = translations['en']; 
    const userName = currentUser ? currentUser.displayName || 'Unknown User' : 'Guest';
    const userLabel = translations[currentLang].csv_user_label || 'User Name';
    const totalEarnings = (parseFloat(totalEl.textContent) * HOURLY_RATE).toFixed(2);
    const currency = translations[currentLang].currency || '‡∏ø';
    
    const header=['Date','Start','End','Duration','Rounded Hours','Task'];
    let csv = `${userLabel}:,${userName}\n\n`; 
    csv += header.join(',') + '\n';
    
    filtered.forEach(r=> csv += [r.date, r.isDayOff? 'Day Off': r.start, r.isDayOff? 'Day Off': r.end, r.isDayOff? 'Day Off': r.duration, r.isDayOff? '0.00': r.rounded.toFixed(2), `"${(r.task||'').replace(/"/g,'""')}"`].join(',') + '\n');
    csv += `\n${translations[currentLang].total_label},,, ,${totalEl.textContent}\n`;
    csv += `${translations[currentLang].earnings_label} (Gross),,, ,${(parseFloat(totalEl.textContent) * HOURLY_RATE).toFixed(2)} ${currency}\n`;
    csv += `${translations[currentLang].loan_label} (Current),,, ,${currentLoanAmount.toFixed(2)} ${currency}\n`;
    csv += `${translations[currentLang].earnings_label} (Net),,, ,${netEarnings} ${currency}\n`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `VannTrack_${userName.replace(/\s/g, '_')}_${selectedYear}-${String(selectedMonth+1).padStart(2,'0')}.csv`; document.body.appendChild(a); a.click(); a.remove();
  });

  printBtn.addEventListener('click', ()=> window.print());

  // month nav
  prevMonthBtn.addEventListener('click', ()=>{ selectedMonth--; if(selectedMonth<0){ selectedMonth=11; selectedYear--; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  nextMonthBtn.addEventListener('click', ()=>{ selectedMonth++; if(selectedMonth>11){ selectedMonth=0; selectedYear++; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  todayMonthBtn.addEventListener('click', ()=>{ const now=new Date(); selectedYear=now.getFullYear(); selectedMonth=now.getMonth(); localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });

  // theme
  function applyTheme(){ 
    const t = localStorage.getItem(THEME) || 'dark'; 
    if(t==='light'){ 
      document.body.classList.add('light-mode'); 
      document.getElementById('theme-toggle').textContent='‚òÄÔ∏è'; 
    } else { 
      document.body.classList.remove('light-mode'); 
      document.getElementById('theme-toggle').textContent='üåô'; 
    } 
  }
  document.getElementById('theme-toggle').addEventListener('click', ()=>{ 
    const now = document.body.classList.toggle('light-mode')? 'light':'dark'; 
    localStorage.setItem(THEME, now); 
    applyTheme(); 
  });

  // language
  function applyLanguageTexts(){
    const t = translations[currentLang];
    const currency = t.currency || '‡∏ø';
    
    document.getElementById('app-title').textContent = t.app_title;
    document.getElementById('app-sub').textContent = t.sub;
    
    // Update Sign out button
    signOutBtn.textContent = t.sign_out_btn;
    
    // Update Input Labels
    dateLabel.textContent = t.date_label;
    startLabel.textContent = t.in_label;
    endLabel.textContent = t.out_label;
    loanLabel.textContent = t.loan_label; 
    taskLabel.textContent = t.task_placeholder;
    taskEl.placeholder = t.task_placeholder;
    
    if (currentUser && currentUser.displayName) {
        signedText.textContent = `Signed in: ${currentUser.displayName}`;
    }

    // Check if we are in edit mode
    if (editId) {
      addBtn.textContent = 'üíæ Save';
    } else {
      addBtn.textContent = '‚ûï ' + t.add_entry;
    }
    
    dayOffBtn.textContent = 'üèñÔ∏è ' + t.add_dayoff;
    
    // Month Label Update Logic
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang] || 'en-US';
    monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    
    // total label for header
    totalHeaderEl.innerHTML = `${t.total_label}: <span id="total">${totalEl.textContent}</span>`;
    
    // Earnings label update
    const currentEarnings = parseFloat(earningsAmount.textContent.replace(/[^\d.]/g, '')) || 0;
    document.getElementById('earnings-label-text').textContent = t.earnings_label;
    earningsDisplay.innerHTML = `${t.earnings_label}: <span id="earnings-amount">${currentEarnings.toFixed(2)} ${currency}</span>`;

    // Admin Button Text
    adminMenuBtn.textContent = t.admin_dashboard;
  }
  langButtons.addEventListener('click', (ev)=>{ 
    const b=ev.target; 
    const lang=b.getAttribute('data-lang'); 
    if(!lang) return; 
    currentLang = lang; 
    localStorage.setItem(LANG,currentLang); 
    render(); 
  });

  // init
  function init(){
    showLoadingState(); 

    loadLocal();
    const saved = localStorage.getItem(MONTH);
    if(saved){ try{ const o=JSON.parse(saved); selectedYear=o.y; selectedMonth=o.m; }catch(e){} }
    if(typeof selectedYear==='undefined'){ const now=new Date(); selectedYear=now.getFullYear(); selectedMonth=now.getMonth(); }
    dateEl.valueAsDate = new Date(selectedYear, selectedMonth, Math.min(new Date().getDate(),28));
    currentLang = localStorage.getItem(LANG) || currentLang;
    applyTheme();
  }
  init();

  </script>
</body>
</html>
