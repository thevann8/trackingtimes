<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>TheVann Track Duration ‚Äî v8 (Cool Design)</title>
  <meta name="description" content="Track work time with custom rounding, month view, multi-language, dark/light theme, CSV, print-ready and Google sign-in." />
  
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* =================================
       NEW: Cool Design Theme Variables
    ================================= */
    :root{
      --bg: #0a0a0a; 
      --card: #111; 
      --accent: #00ff9d; 
      --accent-2: #00d1ff; /* Added accent 2 */
      --text: #f0f0f0; 
      --muted: #777;
      --glow: 0 0 15px rgba(0,255,157,0.4);
      --input-bg: rgba(255,255,255,0.08);
      --table-border: rgba(255,255,255,0.08);
      
      /* Keep functional colors */
      --success:#16a34a; 
      --danger:#ef4444; 
      --dayoff-bg: rgba(239, 68, 68, 0.15); 
      --dayoff-border: #ef4444; 
      --dayoff-text: #ffcfcf;
      --earnings-color: #fbbd0a; 
      --advance-color: #f472b6; 
      --net-earnings-color: var(--success);
    }
    body.light-mode{
      --bg: #f8f8f8; 
      --card: #fff; 
      --accent: #00c980; 
      --accent-2: #00a1ff;
      --text: #111; 
      --muted: #666;
      --glow: 0 0 15px rgba(0,201,128,0.2);
      --input-bg: #f4f4f4;
      --table-border: #eee;
      
      --dayoff-bg: #fff0f0; 
      --dayoff-border: #cc3333; 
      --dayoff-text: #cc3333;
      --earnings-color: #e38200; 
      --advance-color: #db2777; 
      --net-earnings-color: var(--success);
    }

    /* General Styles */
    *{box-sizing:border-box; transition: all 0.3s ease-in-out;}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); 
      font-family: 'Space Grotesk', sans-serif; /* NEW FONT */
      padding: 14px; 
      padding-top: 60px; /* NEW: Push content down for fixed header */
      line-height: 1.5;
    }
    .wrap{max-width:980px;margin:0 auto}
    
    /* NEW: Card Style */
    .card{
      background: var(--card); border-radius: 20px; padding: 1.2rem;
      margin-bottom: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      border: 1px solid var(--table-border);
      transition: all 0.3s ease;
    }
    body.light-mode .card {
        border-color: #e8e8e8;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* Header Message (Only on Auth Page) */
    .header-message {
        text-align: center; color: var(--muted); font-size: 10px; 
        padding: 5px; margin-bottom: 10px;
        line-height: 1.4;
    }

    /* App Header (No longer a card) */
    header.app-head{
      display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;
      gap:8px; position: relative; 
      padding-top: 0; /* REMOVED padding-top */
      background: transparent; border: none; box-shadow: none; padding: 16px 0; 
    }
    
    .title-wrap { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 180px; }
    #app-logo { width: 36px; height: 36px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
    h1.title{margin: 0; font-size:1.6rem; font-weight: 700;} /* Bolder title */
    .subtitle{color:var(--muted);font-size:12px;margin-top:4px}

    /* =================================
       AUTH AREA (NEW FONT/STYLE)
    ================================= */
    .auth-area{
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        min-height:calc(100vh - 74px); /* Adjusted for new body padding */
        margin:0; padding: 20px 0; /* Adjusted padding */
        gap: 15px;
    }
    #auth-logo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; display: block; }
    .auth-area-title { font-size: 1.6rem; font-weight: 700; margin: 0; color: var(--text); text-align: center; }
    .auth-controls { display: flex; justify-content: center; align-items: center; gap: 10px; }

    .auth-card {
        background: var(--card); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        border: 1px solid var(--table-border);
        padding: 24px 28px; width: 100%; max-width: 400px; animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .auth-pane-sub { font-size: 14px; color: var(--muted); text-align: center; margin-top: 0; margin-bottom: 20px; }
    /* NEW Auth Button Style */
    .auth-card .auth-btn { width: 100%; max-width: 100%; justify-content: center; padding: 0.9rem 1.4rem; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; font-size: 0.95rem; }
    .auth-card .input-group { width: 100%; max-width: 100%; margin-bottom: 15px; }
    
    /* NEW: Input style for ALL inputs */
    input[type=date],input[type=time],input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel]{
        width: 100%; padding: 0.9rem; border: 1px solid var(--table-border); border-radius: 14px;
        background: var(--input-bg); color: var(--text); font-size: 1rem;
        font-family: 'Space Grotesk', sans-serif;
        margin: 0.4rem 0; transition: all 0.3s;
        min-width: unset; /* Override old min-width */
    }
    input:focus, textarea:focus { 
        outline: none; background: rgba(255,255,255,0.15); 
        box-shadow: 0 0 0 3px var(--accent); border-color: var(--accent);
    }
    body.light-mode input[type=date], body.light-mode input[type=time], body.light-mode input[type=text],
    body.light-mode input[type=number], body.light-mode input[type=email], body.light-mode input[type=password], body.light-mode input[type=tel] { 
        background: #f9f9f9; border-color: #ddd; color: var(--text); 
    }
    body.light-mode input:focus { background: #fff; }

    /* NEW: Button Styles */
    .btn{padding: 0.8rem 1.4rem; border: none; border-radius: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.95rem; width: 100%;}
    
    .btn.primary { /* For Add Entry */
      background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #000;
      box-shadow: 0 4px 15px rgba(0,255,157,0.3);
    }
    .btn.primary:hover { transform: translateY(-2px); box-shadow: var(--glow); }
    
    /* NEW: Red Button Style for Day Off */
    button#dayoff-btn {
      background: var(--danger);
      color: #fff; /* White text on red */
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); /* Red glow */
      border: none; /* Remove border */
    }
    button#dayoff-btn:hover {
      background: #cc3333; /* Darker red on hover */
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4); /* Stronger glow */
      color: #fff;
    }

    .btn.advance-btn { /* For Add Advance */
        background: linear-gradient(135deg, #f472b6, #f977c8);
        color: #fff;
        box-shadow: 0 4px 15px rgba(244,114,182,0.3);
    }
    .btn.advance-btn:hover { box-shadow: 0 0 15px rgba(244,114,182,0.4); transform: translateY(-2px); }

    /* Auth Page Buttons */
    .auth-btn.primary { background: var(--accent); color: #000; box-shadow: 0 4px 15px rgba(0,255,157,0.3); }
    .auth-btn.primary:hover { transform: translateY(-2px); box-shadow: var(--glow); }
    .auth-btn.google-btn { background: var(--card); border: 1.5px solid var(--table-border); color: var(--text); }
    .auth-btn.google-btn:hover { background: var(--input-bg); border-color: var(--accent); }
    body.light-mode .auth-btn.google-btn { background: #fff; border-color: #ccc; color: #333; }
    body.light-mode .auth-btn.google-btn:hover { background: #f9f9f9; }

    .auth-btn .google-icon {
        width: 18px; height: 18px; margin-right: 10px; background-size: contain; background-repeat: no-repeat;
        /* <<< ·Äî·Ä±·Äõ·Ä¨ (·ÅÉ) - Google Icon Base64 URL ·ÄÄ·Ä≠·ÄØ ·Äí·ÄÆ·Äô·Äæ·Ä¨·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ >>> */
        background-image: url('YOUR_GOOGLE_ICON_BASE64_URL_HERE');
        background-color: transparent; border: none; padding: 0;
    }
    
    .auth-divider { display: flex; align-items: center; text-align: center; color: var(--muted); font-size: 12px; font-weight: 600; margin: 20px 0; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--table-border); }
    .auth-divider span { padding: 0 10px; }
    
    .auth-switch-link { color: var(--accent); font-size: 14px; cursor: pointer; margin-top: 20px; text-align: center; display: block; }
    .auth-switch-link:hover { color: var(--accent-2); }
    .forgot-password-link { color: var(--muted); font-size: 13px; text-align: right; display: block; margin-top: -10px; margin-bottom: 20px; cursor: pointer;}
    .forgot-password-link:hover { color: var(--text); }
    
    /* UPDATED: Terms Footer Text */
    .auth-terms-footer { 
        font-size: 12px; color: var(--muted); text-align: center; 
        line-height: 1.5; margin-top: 20px;
    }
    
    /* Signed State Bar */
    #signedState {
        display: none; position: fixed; /* Changed to fixed */
        top: 0px; left: 0; right: 0; /* Full width */
        padding: 8px 12px; background: var(--card);
        border-bottom: 1px solid var(--table-border);
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        flex-direction: row; align-items: center; 
        justify-content: space-between; gap: 8px; 
        z-index: 1000;
        border-radius: 0; /* No rounded corners */
    }
    .social-icons { display: flex; align-items: center; gap: 10px; flex-basis: 100px; justify-content: flex-start; }
    .social-icon svg { width: 18px; height: 18px; color: var(--muted); transition: color 0.2s ease-out; }
    .social-icon:hover svg { color: var(--text); }
    body.light-mode .social-icon:hover svg { color: var(--accent); }
    .signed-as { color:var(--success); font-weight:700; font-size:13px; white-space: nowrap; flex-grow: 1; text-align: center; }
    .auth-btn.secondary { flex-shrink: 0; flex-basis: auto; background: var(--input-bg); color: var(--muted); border: 1.5px solid var(--table-border); padding: 4px 10px; font-size: 12px; margin-bottom: 0; box-shadow: none; border-radius: 14px;}
    .auth-btn.secondary:hover { background: var(--accent); color: #000; border-color: var(--accent); }

    /* Right Controls (App Header) & Auth Controls */
    .right-controls, .auth-controls {display:flex;align-items:center;gap:8px}
    .lang-select{display:flex;gap:6px}
    .lang-select button{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:14px;color:var(--text);cursor:pointer;font-size:13px}
    body.light-mode .lang-select button { border-color: #ccc; }
    .toggle{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:14px;cursor:pointer}
    body.light-mode .toggle { border-color: #ccc; }
    #admin-menu-btn { background: var(--danger); color: #fff; font-size: 16px; display: none; border-radius: 14px; }
    #admin-menu-btn:hover { background: #cc3333; }

    /* Top Controls Area (App Content) */
    .controls-top{ display:flex; flex-wrap:wrap; gap:8px; align-items: center; margin-top:12px; justify-content: space-between; }
    .month-nav-controls { display: flex; gap: 8px; align-items: center; flex-grow: 1; justify-content: center; min-width: 280px; }
    #month-label { font-weight:700; min-width:140px; text-align:center; flex-shrink: 0; }
    .month-nav-controls .btn { padding: 8px 10px; } /* Kept ghost style */
    .totals-controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .export-print-controls { display: flex; gap: 8px; margin-left: auto; }
    
    .total-card{ background:var(--card); padding:10px 15px; border-radius:16px; color:var(--text); font-weight:700; font-size: 15px; display: flex; align-items: center; justify-content: space-between; gap: 8px; border: 1px solid var(--table-border); } 
    .total-card span#total { color: var(--accent); font-size: 16px;}
    .visibility-toggle { background: transparent; border: none; cursor: pointer; font-size: 18px; padding: 0 2px; color: var(--muted); line-height: 1; margin-left: 5px; }
    .visibility-toggle:hover { color: var(--text); }

    /* NEW Earnings Display */
    #earnings-display { background: var(--card); padding: 10px 15px; border-radius: 16px; color: var(--text); font-weight: 700; font-size: 15px; border: 1px solid var(--table-border); line-height: 1.6; }
    #earnings-display div { display: flex; justify-content: space-between; align-items: center; }
    #earnings-amount-gross { color: var(--earnings-color); font-weight: 800; font-size: 16px; }
    #earnings-amount-advance { color: var(--advance-color); font-weight: 800; font-size: 16px; }
    #earnings-amount-net { color: var(--net-earnings-color); font-weight: 800; font-size: 18px; border-top: 1px dashed var(--muted); padding-top: 5px; margin-top: 5px;}

    /* Entry Grid */
    .entry-grid{display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;margin-top:12px} /* new gap */
    .entry-grid .input-group { flex: 1; min-width: 120px; }
    .entry-grid .preview { align-self: flex-end; padding-bottom: 0.4rem; color:var(--muted);font-size:13px; }
    .entry-grid div:last-of-type { display: flex; gap: 0.5rem; flex-basis: 100%;} /* Buttons span full width */

    /* Tables */
    .table-wrap{overflow:auto;margin-top:14px;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:700px}
    thead th{padding:10px 12px;text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;border-bottom:2px solid var(--table-border)} /* Thicker line */
    tbody td{padding:10px 12px;border-bottom:1px solid var(--table-border)}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}
    tr.day-off { background: var(--dayoff-bg) !important; color: var(--dayoff-text) !important; font-weight: 600; border: 1px solid var(--dayoff-border) !important; }
    tr.day-off td { font-style: italic; border-bottom: 1px solid var(--dayoff-border) !important; padding: 10px 12px; }
    tr.day-off td:first-child::before { content: "üö® "; margin-right: 5px; }
    .actions{display:flex;gap:8px}
    .chip{padding:6px 10px;border-radius:14px;font-weight:600;cursor:pointer} /* New radius */
    .chip.edit{background:var(--success);color:#fff}
    .chip.del{background:var(--danger);color:#fff}

    /* Advance Section */
    .advance-section { margin-top: 16px; }
    .advance-section h3 { margin-top: 0; color: var(--advance-color); }
    .advance-grid { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px;}
    .advance-grid .input-group { flex: 1; min-width: 120px; }
    .advance-grid .input-group.amount-group { flex: 0 1 150px; }
    .advance-grid .input-group.note-group { flex: 2; }
    #advances-table { min-width: 500px; }
    #advances-table td:nth-child(2) { color: var(--advance-color); font-weight: 700; }

    /* Admin Modal */
    #admin-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; animation: overlayFadeIn 0.3s ease-out; }
    #admin-panel { margin-top: 0; width: 100%; max-width: 500px; background: linear-gradient(180deg, var(--danger), #a13030); border-color: #ff6060; position: relative; animation: panelSlideIn 0.4s ease-out; border-radius: 20px; }
    #admin-panel h2 { margin-top: 0; color: #fff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px; }
    #admin-panel .input-group label { color: #ffcfcf; }
    #admin-panel .input-group input { background: var(--input-bg); }
    #admin-results { margin-top: 15px; background: var(--bg); padding: 10px 15px; border-radius: 8px; display:none; color: var(--text); line-height: 1.7; }
    #admin-results strong { color: var(--text); display: inline-block; min-width: 180px; }
    #admin-results span { font-weight: bold; }
    #admin-results span.gross { color: var(--earnings-color); } #admin-results span.advance { color: var(--advance-color); } #admin-results span.net { color: var(--net-earnings-color); }
    #admin-close-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; line-height: 1; cursor: pointer; transition: background 0.2s ease; }
    #admin-close-btn:hover { background: rgba(255,255,255,0.4); }

    /* NEW: Loading Spinner Screen */
    .loader {
        border: 5px solid var(--input-bg); border-top: 5px solid var(--accent); 
        border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-text { color: var(--muted); font-size: 14px; margin-top: 10px; }

    /* Mobile & Print Styles */
    @media(max-width:768px){
      .entry-grid, .advance-grid, .controls-top {flex-direction:column; align-items:stretch;}
      .controls-top { gap: 12px; }
      .month-nav-controls { justify-content: space-between; width: 100%; order: 1; }
      .totals-controls { width: 100%; order: 2; flex-direction: column; align-items: stretch;}
      .export-print-controls { width: 100%; order: 3; margin-left: 0; justify-content: center;}
      .entry-grid div:last-of-type { flex-direction: column; } /* Stack add/dayoff buttons on mobile */
      input[type=date],input[type=time],input[type=text],input[type=number],.btn,.total-card, #earnings-display{width:100%; min-width: unset;}
      .input-group { width: 100%; } table{min-width: 600px} #advances-table { min-width: 400px; }
      header.app-head { padding-top: 0; } /* Removed padding */
      /* #signedState styles are now default */
      .social-icons { flex-basis: auto; } .signed-as { font-size: 12px; }
      #admin-panel { max-width: 95%; } .auth-controls { flex-wrap: wrap; justify-content: center;}
      #admin-results strong { min-width: 130px;}
    }
    /* Clean Print Design */
    @media print{ /* ... (Print styles remain the same) ... */ }
  </style>
</head>
<body>
  
  <div id="signedState" style="display:none;">
      <div class="social-icons">
          <a href="https://www.instagram.com/thevann3.0" target="_blank" class="social-icon" title="Instagram">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37a4 4 0 1 1-7.9 0 4 4 0 0 1 7.9 0z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
          </a>
          <a href="https://x.com/VannNft3" target="_blank" class="social-icon" title="X (Twitter)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h1.939L6.486 3.24H4.438Z"></path></svg>
          </a>
      </div>
      <div class="signed-as" id="signedText"></div> 
      <button id="signOut" class="auth-btn secondary"></button>
  </div>
  
  <div class="wrap">

<div class="auth-area" id="auth-area" style="display:none;">
    <div class="header-message" id="global-header-message">
        Gm Mfers<br>why are u guys so dumb
    </div>
    <img id="auth-logo" src="YOUR_AUTH_LOGO_URL_HERE" alt="App Logo" />
    <h1 class="auth-area-title" id="auth-title-text">TheVann Tracker</h1>
    <div class="auth-controls">
         <div class="lang-select" id="auth-lang-buttons"> <button data-lang="en">üá∫üá∏ EN</button> <button data-lang="my">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨</button> <button data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button> </div>
         <div class="toggle" id="auth-theme-toggle" title="Toggle theme">üåô</div>
         </div>
    
    <div class="auth-card">
        <form id="signin-form">
            <p class="auth-pane-sub" id="auth-signin-sub">Sign in with your email or Google.</p>
            <div class="input-group"> <label for="login-email">Email</label> <input id="login-email" type="email" placeholder="you@example.com" required/> </div>
            <div class="input-group"> <label for="login-password">Password</label> <input id="login-password" type="password" placeholder="Your password" required/> </div>
            <a class="forgot-password-link" id="forgot-password-link">Forgot Password?</a>
            <button id="login-btn" type="submit" class="auth-btn primary">Sign In</button>
            <div class="auth-divider"> <span>OR</span> </div>
            <button id="googleSignIn" type="button" class="auth-btn google-btn"> <div class="google-icon"></div> Continue with Google </button>
            <a class="auth-switch-link" id="show-register">Need an account? Register</a>
        </form>

        <form id="register-form" style="display: none;">
             <p class="auth-pane-sub" id="auth-register-sub">Create a new account with your email.</p>
             <div class="input-group"> <label for="register-username">Username</label> <input id="register-username" type="text" placeholder="Your unique name" required/> </div>
             <div class="input-group"> <label for="register-email">Email</label> <input id="register-email" type="email" placeholder="you@example.com" required/> </div>
             <div class="input-group"> <label for="register-password">Password</label> <input id="register-password" type="password" placeholder="Min. 6 characters" required/> </div>
             <button id="register-btn" type="submit" class="auth-btn primary">Register Account</button>
             
             <p class="auth-terms-footer" id="terms-footer-text">why u ain't got brain mfers</p>

             <a class="auth-switch-link" id="show-signin">Already have an account? Sign In</a>
        </form>

        <form id="reset-password-form" style="display: none;">
            <p class="auth-pane-sub" id="auth-reset-sub">Reset your password.</p>
            <div class="input-group"> <label for="reset-email">Email</label> <input id="reset-email" type="email" placeholder="Your account email" required/> </div>
            <button id="reset-btn" type="submit" class="auth-btn primary">Send Reset Link</button>
            <a class="auth-switch-link" id="back-to-signin-from-reset">Back to Sign In</a>
        </form>

        <p id="auth-message" style="color:var(--accent); margin-top: 15px; text-align: center; min-height: 20px;"></p>
        <div id="recaptcha-container" style="margin-top: 10px; display: flex; justify-content: center;"></div>
    </div>
</div>

    <div id="username-modal" style="display:none;"> <div id="username-form-card" class="card"> <h3 id="modal-title">...</h3> <p id="modal-subtitle">...</p> <input id="username-input-field" type="text"/> <button id="save-username-btn" class="btn primary">...</button> </div> </div>
    
    <div class="auth-area" id="loading-screen" style="display:none;">
        <div class="card" style="align-items: center; padding: 30px;">
            <div class="loader"></div> 
            <p id="loading-text">Checking authentication status...</p>
        </div>
    </div>

    <div class="card" id="app-content" style="display:none;">
      
      <header class="app-head">
        <div class="title-wrap">
            <img id="app-logo" src="YOUR_APP_LOGO_URL_HERE" alt="App Logo" /> 
            <div> <h1 class="title" id="app-title">...</h1> <div class="subtitle" id="app-sub">...</div> </div> 
        </div>
        <div class="right-controls"> <div class="lang-select" id="lang-buttons"> <button data-lang="en">üá∫üá∏ EN</button> <button data-lang="my">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨</button> <button data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button> </div> <div style="display:flex;gap:8px;align-items:center"> <div class="toggle" id="theme-toggle">üåô</div> <button id="admin-menu-btn" class="toggle">‚öôÔ∏è</button> </div> </div>
      </header>

      <div class="advance-section"> <h3 id="advance-title">...</h3> <div class="advance-grid"> <div class="input-group"> <label id="advance-date-label" for="advance-date">...</label> <input id="advance-date" type="date" /> </div> <div class="input-group amount-group"> <label id="advance-amount-label" for="advance-amount">...</label> <input id="advance-amount" type="number"/> </div> <div class="input-group note-group"> <label id="advance-note-label" for="advance-note">...</label> <input id="advance-note" type="text"/> </div> <button id="add-advance-btn" class="btn advance-btn">...</button> </div> <div class="table-wrap"> <table id="advances-table"> <thead> <tr> <th id="th-advance-date">...</th> <th id="th-advance-amount">...</th> <th id="th-advance-note">...</th> <th class="actions" id="th-advance-actions">...</th> </tr> </thead> <tbody id="advances-body"></tbody> </table> </div> </div>

      <div class="controls-top">
        <div class="month-nav-controls"> <button id="prev-month" class="ghost btn">‚óÄ</button> <div id="month-label">...</div> <button id="next-month" class="ghost btn">‚ñ∂</button> <button id="today-month" class="ghost btn">üóìÔ∏è Today</button> </div>
        <div class="totals-controls"> <div class="total-card" id="total-header"> <span id="total-label">...</span> <span id="total">0.00</span> <button id="toggle-total-hours" class="visibility-toggle">üëÅÔ∏è</button> </div> <div class="earnings-wrapper"> <div id="earnings-display"></div> </div> </div>
        <div class="export-print-controls"> <button id="export-csv" class="ghost btn">...</button> <button id="print-btn" class="ghost btn">...</button> </div>
      </div>

      <div class="entry-grid"> <div class="input-group"> <label id="date-label" for="date-input">...</label> <input id="date-input" type="date" /> </div> <div class="input-group"> <label id="start-label" for="start-input">...</label> <input id="start-input" type="time" /> </div> <div class="input-group"> <label id="end-label" for="end-input">...</label> <input id="end-input" type="time" /> </div> <div class="input-group" style="flex-grow: 1;"> <label id="task-label" for="task-input">...</label> <input id="task-input" type="text"/> </div> <div class="preview" id="preview">...</div> <div> <button id="add-btn" class="btn primary">...</button> <button id="dayoff-btn" class="btn ghost">...</button> </div> </div>
      <div class="table-wrap"> <table id="entries-table"> <thead> <tr> <th id="th-date">...</th> <th id="th-start">...</th> <th id="th-end">...</th> <th id="th-duration">...</th> <th id="th-rounded">...</th> <th id="th-task">...</th> <th class="actions" id="th-actions">...</th> </tr> </thead> <tbody id="entries-body"></tbody> </table> </div>
      <div class="footer" style="display:none;"> <div class="total-card">Total Rounded Hours: <span id="total-footer">0.00</span></div> </div>
    </div>
    <div id="admin-modal-overlay"> <div id="admin-panel" class="card"> <button id="admin-close-btn">&times;</button> <h2>Admin Panel</h2> <div class="input-group"> <label for="admin-search-uid">Search User by UID</label> <input id="admin-search-uid" type="text"/> </div> <button id="admin-search-btn" class="btn primary" style="background:#fff; color:#b91c1c; border:none;">Search</button> <div id="admin-results" style="display:none;"></div> </div> </div>
  </div> <script type="module">
  // --- Firebase imports (REMOVED Phone Auth) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, 
    signInWithPopup, signOut, onAuthStateChanged, updateProfile, 
    createUserWithEmailAndPassword, sendEmailVerification, 
    signInWithEmailAndPassword, sendPasswordResetEmail 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // --- Firebase config & Init ---
  const firebaseConfig = { apiKey: "AIzaSyBPt8cZMMW6gs8TLV-7EEvpJJVZ33DH23k", authDomain: "thevanntrackduration-81ee0.firebaseapp.com", projectId: "thevanntrackduration-81ee0", storageBucket: "thevanntrackduration-81ee0.firebasestorage.app", messagingSenderId: "56786707859", appId: "1:56786707859:web:75be757ceb95604984f466", measurementId: "G-QNG2F09LWL" };
  const app = initializeApp(firebaseConfig); const auth = getAuth(app); const provider = new GoogleAuthProvider(); const db = getFirestore(app);

  // --- CONSTANTS ---
  const HOURLY_RATE = 40.00; const ADMIN_UID = 'h1OJyFLAFDRWgwiZxf2G1rbIapl1';
  // --- DOM Elements ---
  const globalHeaderMessage = document.getElementById('global-header-message');
  const authArea = document.getElementById('auth-area'), authCard = authArea.querySelector('.auth-card'), authLogo = document.getElementById('auth-logo'), authTitleText = document.getElementById('auth-title-text'), authControls = authCard.querySelector('.auth-controls'), authLangButtons = document.getElementById('auth-lang-buttons'), authThemeToggle = document.getElementById('auth-theme-toggle'), authMessageEl = document.getElementById('auth-message');
  const usernameModal = document.getElementById('username-modal'), usernameInputField = document.getElementById('username-input-field'), saveUsernameBtn = document.getElementById('save-username-btn');
  const loadingScreen = document.getElementById('loading-screen');
  const appContent = document.getElementById('app-content'), signedState = document.getElementById('signedState'), signedText = document.getElementById('signedText'), signOutBtn = document.getElementById('signOut'), appLogo = document.getElementById('app-logo'), langButtons = document.getElementById('lang-buttons'), themeToggle = document.getElementById('theme-toggle'), adminMenuBtn = document.getElementById('admin-menu-btn');
  const advanceSection = appContent.querySelector('.advance-section'), advanceDateEl = document.getElementById('advance-date'), advanceAmountEl = document.getElementById('advance-amount'), advanceNoteEl = document.getElementById('advance-note'), addAdvanceBtn = document.getElementById('add-advance-btn'), advancesBody = document.getElementById('advances-body'), advanceTitle = document.getElementById('advance-title'), advanceDateLabel = document.getElementById('advance-date-label'), advanceAmountLabel = document.getElementById('advance-amount-label'), advanceNoteLabel = document.getElementById('advance-note-label');
  const controlsTop = appContent.querySelector('.controls-top'), prevMonthBtn = document.getElementById('prev-month'), monthLabel = document.getElementById('month-label'), nextMonthBtn = document.getElementById('next-month'), todayMonthBtn = document.getElementById('today-month'), totalHeaderEl = document.getElementById('total-header'), totalLabelSpan = document.getElementById('total-label'), totalEl = totalHeaderEl.querySelector('#total'), toggleTotalHoursBtn = document.getElementById('toggle-total-hours'), earningsDisplay = document.getElementById('earnings-display'), exportBtn = document.getElementById('export-csv'), printBtn = document.getElementById('print-btn');
  const entryGrid = appContent.querySelector('.entry-grid'), dateEl = document.getElementById('date-input'), startEl = document.getElementById('start-input'), endEl = document.getElementById('end-input'), taskEl = document.getElementById('task-input'), previewEl = document.getElementById('preview'), addBtn = document.getElementById('add-btn'), dayOffBtn = document.getElementById('dayoff-btn');
  const entriesBody = document.getElementById('entries-body');
  const dateLabel = document.getElementById('date-label'), startLabel = document.getElementById('start-label'), endLabel = document.getElementById('end-label'), taskLabel = document.getElementById('task-label');
  const thDate = document.getElementById('th-date'), thStart = document.getElementById('th-start'), thEnd = document.getElementById('th-end'), thDuration = document.getElementById('th-duration'), thRounded = document.getElementById('th-rounded'), thTask = document.getElementById('th-task'), thActions = document.getElementById('th-actions'), thAdvanceDate = document.getElementById('th-advance-date'), thAdvanceAmount = document.getElementById('th-advance-amount'), thAdvanceNote = document.getElementById('th-advance-note'), thAdvanceActions = document.getElementById('th-advance-actions');
  const adminModalOverlay = document.getElementById('admin-modal-overlay'), adminPanel = document.getElementById('admin-panel'), adminCloseBtn = document.getElementById('admin-close-btn'), adminSearchBtn = document.getElementById('admin-search-btn'), adminSearchInput = document.getElementById('admin-search-uid'), adminResultsEl = document.getElementById('admin-results');
  const signinForm = document.getElementById('signin-form'), registerForm = document.getElementById('register-form'), resetPasswordForm = document.getElementById('reset-password-form');
  const loginEmailEl = document.getElementById('login-email'), loginPasswordEl = document.getElementById('login-password'), loginBtn = document.getElementById('login-btn'), googleSignInBtn = document.getElementById('googleSignIn');
  const registerUsernameEl = document.getElementById('register-username'), registerEmailEl = document.getElementById('register-email'), registerPasswordEl = document.getElementById('register-password'), registerBtn = document.getElementById('register-btn');
  const resetEmailEl = document.getElementById('reset-email'), resetBtn = document.getElementById('reset-btn');
  const showRegisterLink = document.getElementById('show-register'), showSigninLink = document.getElementById('show-signin'), forgotPasswordLink = document.getElementById('forgot-password-link'), backToSigninFromReset = document.getElementById('back-to-signin-from-reset');
  const authSigninSub = document.getElementById('auth-signin-sub'), authRegisterSub = document.getElementById('auth-register-sub'), authResetSub = document.getElementById('auth-reset-sub');
  const emailTermsFooter = document.getElementById('terms-footer-text');

  // --- Keys for Local Storage ---
  const STORAGE_ENTRIES = 'vann_v8_entries', STORAGE_ADVANCES = 'vann_v8_advances', THEME = 'vann_v8_theme', LANG = 'vann_v8_lang', MONTH = 'vann_v8_month', EARNINGS_HIDDEN = 'vann_v8_earnings_hidden', TOTAL_HOURS_HIDDEN = 'vann_v8_total_hours_hidden';
  // --- Translations (REMOVED Phone) ---
  const translations = {
    en: { app_title:'TheVann Track Duration', sub:'Auto rounding, monthly view', add_entry:'Add Entry', add_dayoff:'Day Off', export_csv:'Export CSV', print:'Print', duration_default:'Duration: 00:00 (0.00h)', total_label:'Total Rounded Hours', alert_fill:'Please fill Date, Start and End.', edit: '‚úèÔ∏è Edit', del: 'üóëÔ∏è Delete', day_off_text: 'Day Off', date_label: 'Date', in_label: 'IN', out_label: 'OUT', task_placeholder: 'Task / notes (optional)', csv_user_label: 'User Name', modal_title: 'Set Your Display Name', modal_subtitle: 'This name will be used in reports.', save_name: 'Save Name', sign_out_btn: 'Sign out', currency: '‡∏ø', th_date: 'Date', th_start: 'Start', th_end: 'End', th_duration: 'Duration', th_rounded: 'Rounded (hrs)', th_task: 'Task', th_actions: 'Actions', advance_title: 'Salary Advances', advance_date_label: 'Date', advance_amount_label: 'Amount', advance_note_label: 'Note (optional)', advance_note_placeholder: 'Reason for advance...', add_advance: 'Add Advance', th_advance_date: 'Date', th_advance_amount: 'Amount', th_advance_note: 'Note', th_advance_actions: 'Actions', alert_advance_fill: 'Please fill Date and Amount for advance.', alert_advance_amount: 'Advance amount must be a positive number.', gross_earnings: 'Gross Earnings', total_advance: 'Total Advance', net_earnings: 'Net Earnings', auth_title: 'TheVann Tracker', auth_signin_sub: 'Sign in with your email or Google.', auth_register_sub: 'Create a new account with your email.', forgot_password_link: 'Forgot Password?', auth_reset_sub: 'Reset your password.', send_reset_link: 'Send Reset Link', back_to_signin: 'Back to Sign In', reset_email_sent: 'Password reset email sent!', reset_fill_email: 'Please enter your email address.', auth_need_account: 'Need an account? Register', auth_have_account: 'Already have an account? Sign In', auth_terms: 'why u ain\'t got brain mfers' },
    my: { app_title:'Thevann ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏', sub:'·Äú·ÄÖ·Äâ·Ä∫ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·Äô·Äæ·ÄØ·Åä ·Äò·Ä¨·Äû·Ä¨·ÄÖ·ÄÄ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏', add_entry:'·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫', add_dayoff:'·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫', export_csv:'CSV ·Äë·ÄØ·Äê·Ä∫·Äö·Ä∞·Äô·Ää·Ä∫', print:'·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫', duration_default:'·ÄÄ·Äº·Ä¨·ÄÅ·Äª·Ä≠·Äî·Ä∫: 00:00 (0.00·Äî·Ä¨·Äõ·ÄÆ)', total_label:'·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äï·Äê·Ä∫·Äú·Ää·Ä∫·Äî·Ä¨·Äõ·ÄÆ', alert_fill:'·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤·Åä ·ÄÖ·Äê·ÄÑ·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã', edit: '‚úèÔ∏è ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫', del: 'üóëÔ∏è ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫', day_off_text: '·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫', date_label: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', in_label: '·Äù·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', out_label: '·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', task_placeholder: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ (·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Äú·Ä≠·ÄØ·Äï·Ä´)', csv_user_label: '·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Ä°·Äô·Ää·Ä∫', modal_title: '·Äô·Ä≠·Äô·Ä≠·Ä°·Äô·Ää·Ä∫ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Ä´', modal_subtitle: '·Ä§·Ä°·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·ÄÆ·Äõ·ÄÑ·Ä∫·ÄÅ·Ä∂·ÄÖ·Ä¨·Äô·Äª·Ä¨·Ä∏·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äô·Ää·Ä∫·Åã', save_name: '·Ä°·Äô·Ää·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫', sign_out_btn: '·Äë·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫', currency: '‡∏ø', th_date: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', th_start: '·Äù·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_end: '·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_duration: '·ÄÄ·Äº·Ä¨·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_rounded: '·Äî·Ä¨·Äõ·ÄÆ', th_task: '·Ä°·Äú·ÄØ·Äï·Ä∫', th_actions: '·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫', advance_title: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä±·Äô·Äª·Ä¨·Ä∏', advance_date_label: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', advance_amount_label: '·Äï·Äô·Ä¨·Äè', advance_note_label: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ (·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Äú·Ä≠·ÄØ·Äï·Ä´)', advance_note_placeholder: '·Äë·ÄØ·Äê·Ä∫·Äö·Ä∞·Äû·Ää·Ä∑·Ä∫·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·Ä∫·Ä∏...', add_advance: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫', th_advance_date: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', th_advance_amount: '·Äï·Äô·Ä¨·Äè', th_advance_note: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ', th_advance_actions: '·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫', alert_advance_fill: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤ ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫ ·Äï·Äô·Ä¨·Äè ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã', alert_advance_amount: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫ ·Äï·Äô·Ä¨·Äè·Äû·Ää·Ä∫ ·Ä°·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·Äî·Ä∫·Ä∏ ·Äñ·Äº·ÄÖ·Ä∫·Äõ·Äï·Ä´·Äô·Ää·Ä∫·Åã', gross_earnings: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±', total_advance: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·ÄÄ·Äº·Ä≠·ÄØ·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä±', net_earnings: '·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äõ·ÄÑ·ÄΩ·Ä±', auth_title: 'Thevann ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äæ·Äê·Ä∫', auth_signin_sub: 'Email (·Äû·Ä≠·ÄØ·Ä∑) Google ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´·Åã', auth_register_sub: 'Email ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äû·ÄÖ·Ä∫ ·Äï·Äº·ÄØ·Äú·ÄØ·Äï·Ä∫·Äï·Ä´·Åã', forgot_password_link: '·ÄÖ·ÄÄ·Ä¨·Ä∏·Äù·Äæ·ÄÄ·Ä∫·Äô·Ä±·Ä∑·Äî·Ä±·Äû·Äú·Ä¨·Ä∏?', auth_reset_sub: '·ÄÖ·ÄÄ·Ä¨·Ä∏·Äù·Äæ·ÄÄ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äú·Ää·Ä∫·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Ä´·Åã', send_reset_link: 'Reset Link ·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫', back_to_signin: 'Sign In ·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Ää·Ä∫', reset_email_sent: '·ÄÖ·ÄÄ·Ä¨·Ä∏·Äù·Äæ·ÄÄ·Ä∫·Äï·Äº·Äî·Ä∫·Äú·Ää·Ä∫·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äõ·Äî·Ä∫ email ·Äï·Ä≠·ÄØ·Ä∑·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ!', reset_fill_email: '·Äû·ÄÑ·Ä∫·Åè email ·Äú·Ä≠·Äï·Ä∫·ÄÖ·Ä¨·ÄÄ·Ä≠·ÄØ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã', auth_need_account: '·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äò·Ä∞·Ä∏·Äú·Ä¨·Ä∏? ·Äô·Äæ·Äê·Ä∫·Äï·ÄØ·Ä∂·Äê·ÄÑ·Ä∫·Äï·Ä´', auth_have_account: '·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äõ·Äæ·Ä≠·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏·Äú·Ä¨·Ä∏? Sign In ·Äù·ÄÑ·Ä∫·Äï·Ä´', auth_terms: 'why u ain\'t got brain mfers' },
    th: { app_title:'‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ß‡∏ô', sub:'‡∏î‡∏π‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤', add_entry:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', add_dayoff:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', export_csv:'‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV', print:'‡∏û‡∏¥‡∏°‡∏û‡πå', duration_default:'‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: 00:00 (0.00 ‡∏ä‡∏°.)', total_label:'‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©', alert_fill:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', edit: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', del: 'üóëÔ∏è ‡∏•‡∏ö', day_off_text: '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', date_label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', in_label: '‡πÄ‡∏Ç‡πâ‡∏≤', out_label: '‡∏≠‡∏≠‡∏Å', task_placeholder: '‡∏á‡∏≤‡∏ô / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', csv_user_label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', modal_title: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•', modal_subtitle: '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', save_name: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠', sign_out_btn: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', currency: '‡∏ø', th_date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', th_start: '‡πÄ‡∏£‡∏¥‡πà‡∏°', th_end: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', th_duration: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', th_rounded: '‡∏ä‡∏°. (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©)', th_task: '‡∏á‡∏≤‡∏ô', th_actions: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥', advance_title: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', advance_date_label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', advance_amount_label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', advance_note_label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', advance_note_placeholder: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å...', add_advance: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å', th_advance_date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', th_advance_amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', th_advance_note: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', th_advance_actions: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥', alert_advance_fill: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å', alert_advance_amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å', gross_earnings: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°', total_advance: '‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', net_earnings: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', auth_title: 'TheVann Tracker', auth_signin_sub: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠ Google', auth_register_sub: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', forgot_password_link: '‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?', auth_reset_sub: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', send_reset_link: '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï', back_to_signin: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ', reset_email_sent: '‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!', reset_fill_email: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', auth_need_account: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', auth_have_account: '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ', auth_terms: 'why u ain\'t got brain mfers' }
  };
  // --- Application State ---
  let entries = [], advances = [], editId = null, selectedYear, selectedMonth;
  let currentLang = localStorage.getItem(LANG) || 'en', currentUser = null;
  let isEarningsHidden = false, isTotalHoursHidden = false;
  // let confirmationResult = null; // REMOVED

  // --- Helper Functions ---
  function parseHM(t){ if(!t) return null; const [h,m]=t.split(':').map(Number); if(Number.isNaN(h)||Number.isNaN(m)) return null; return h*60+m; }
  function fmtHM(min){ const h=Math.floor(min/60); const m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` }
  function computeRounded(raw){ if(raw<=0) return 0.00; const h=Math.floor(raw/60); const m=raw%60; let H=h; if(m>=0 && m<=29) { return +(H).toFixed(2); } else if(m>=30 && m<=39) { return +(H + 0.5).toFixed(2); } else if(m>=40 && m<=59){ return +(H + 1).toFixed(2); } return +(H).toFixed(2); }
  async function isUsernameTaken(username) { const uRef = doc(db, 'usernames', username.toLowerCase()); const docSnap = await getDoc(uRef); return docSnap.exists(); }

  // --- Update Earnings Display ---
  function updateEarningsDisplay() { const t = translations[currentLang], currency = t.currency || '‡∏ø'; const totalHoursValue = parseFloat(localStorage.getItem('temp_total_hours_for_calc') || '0'); const grossEarnings = (totalHoursValue * HOURLY_RATE); let totalAdvance = 0; advances.filter(a => { const d = new Date(a.date); return d.getFullYear() === selectedYear && d.getMonth() === selectedMonth; }).forEach(a => totalAdvance += a.amount); const netEarnings = grossEarnings - totalAdvance; const hiddenValue = `******** ${currency}`; earningsDisplay.innerHTML = `<div><span>${t.gross_earnings}:</span><span id="earnings-amount-gross">${isEarningsHidden ? hiddenValue : grossEarnings.toFixed(2) + ' ' + currency}</span><button id="toggle-earnings-visibility" class="visibility-toggle earnings-toggle">${isEarningsHidden ? 'üôà' : 'üëÅÔ∏è'}</button></div><div><span>${t.total_advance}:</span><span id="earnings-amount-advance" style="color:var(--advance-color);">${isEarningsHidden ? hiddenValue : totalAdvance.toFixed(2) + ' ' + currency}</span></div><div><span style="font-weight:800;">${t.net_earnings}:</span><span id="earnings-amount-net" style="color:var(--net-earnings-color);">${isEarningsHidden ? hiddenValue : netEarnings.toFixed(2) + ' ' + currency}</span></div>`; const toggleBtn = document.getElementById('toggle-earnings-visibility'); if (toggleBtn) { toggleBtn.addEventListener('click', toggleEarningsVisibility); } }
  function toggleEarningsVisibility() { isEarningsHidden = !isEarningsHidden; localStorage.setItem(EARNINGS_HIDDEN, isEarningsHidden); updateEarningsDisplay(); }
  // --- Update Total Hours Visibility ---
  function updateTotalHoursVisibility() { const t = translations[currentLang]; const totalHoursValue = parseFloat(localStorage.getItem('temp_total_hours_for_calc') || '0'); if (isTotalHoursHidden) { totalEl.textContent = '********'; toggleTotalHoursBtn.textContent = 'üôà'; } else { totalEl.textContent = totalHoursValue.toFixed(2); toggleTotalHoursBtn.textContent = 'üëÅÔ∏è'; } totalLabelSpan.textContent = t.total_label + ':'; }
  // --- Local Storage & Firestore ---
  function saveLocal(){ localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(entries)); localStorage.setItem(STORAGE_ADVANCES, JSON.stringify(advances)); render(); }
  function loadLocal(){ const re = localStorage.getItem(STORAGE_ENTRIES); entries = re ? JSON.parse(re) : []; const ra = localStorage.getItem(STORAGE_ADVANCES); advances = ra ? JSON.parse(ra) : [];}
  async function saveToFirestore(uid){ if(!uid) return; try{ const dRef = doc(db, 'users', uid); await setDoc(dRef, { entries, advances }, { merge: true }); }catch(err){ console.error('saveToFirestore error:', err); }}
  async function loadFromFirestore(uid){ if(!uid) return null; try{ const dRef = doc(db, 'users', uid); const snap = await getDoc(dRef); if(snap.exists()){ const data = snap.data(); return { entries: (Array.isArray(data.entries) ? data.entries : []), advances: (Array.isArray(data.advances) ? data.advances : []) }; } else { return { entries: [], advances: [] }; } }catch(err){ console.error('loadFromFirestore error:', err); return null; }}
  // --- Username Setup ---
  async function handleUsernameSetup(user) { usernameModal.style.display = 'flex'; usernameInputField.value = user.displayName || (user.email ? user.email.split('@')[0] : 'Your Name'); const t = translations[currentLang]; document.getElementById('modal-title').textContent = t.modal_title; document.getElementById('modal-subtitle').textContent = t.modal_subtitle; document.getElementById('save-username-btn').textContent = t.save_name; }
  saveUsernameBtn.addEventListener('click', async () => { const newName = usernameInputField.value.trim(); if (!newName) { alert('Please enter a name.'); return; } if (currentUser) { try { await updateProfile(currentUser, { displayName: newName }); currentUser.displayName = newName; usernameModal.style.display = 'none'; handleUserSignedIn(currentUser); } catch (error) { console.error('Error updating profile:', error); alert('Failed to save name: ' + error.message); } } });
  
  // --- UI State Control (Updated for new loader) ---
  function showLoadingState(){ 
    authArea.style.display = 'none'; appContent.style.display = 'none'; signedState.style.display = 'none'; 
    usernameModal.style.display = 'none'; loadingScreen.style.display = 'flex'; // Use flex to activate centering
    
    const loadingTextEl = document.getElementById('loading-text');
    if (loadingTextEl) loadingTextEl.textContent = 'Checking authentication status...';
  }
  
  // --- Handle User Signed In (REMOVED "Signed in:") ---
  async function handleUserSignedIn(user){
    currentUser = user; const uid = user.uid;
    // Check verification (only for email provider)
    if (user.providerData.some(p => p.providerId === 'password') && !user.emailVerified) { 
        showLoadingState(); 
        const loadingTextEl = document.getElementById('loading-text');
        if (loadingTextEl) loadingTextEl.textContent = `Verification link sent to ${user.email}. Please verify.`;
        authArea.style.display = 'none'; appContent.style.display = 'none'; signedState.style.display = 'none'; 
        try { await signOut(auth); } catch(e) { console.error("Sign out error", e); } 
        return; 
    }
    if (!user.displayName || user.displayName === '' || user.displayName.includes('@')) { await handleUsernameSetup(user); return; }
    signedText.textContent = `${user.displayName}`; // CHANGED
    signedState.style.display = 'flex'; authArea.style.display = 'none'; appContent.style.display = 'block'; loadingScreen.style.display = 'none'; globalHeaderMessage.style.display = 'none'; // Hide message on main app
    adminMenuBtn.style.display = (user.uid === ADMIN_UID) ? 'inline-block' : 'none';
    const cloudData = await loadFromFirestore(uid); if(cloudData === null){ console.warn('Firestore error, using local'); loadLocal(); } else { entries = cloudData.entries; advances = cloudData.advances; if (cloudData.entries.length === 0 && cloudData.advances.length === 0) { const le = localStorage.getItem(STORAGE_ENTRIES), la = localStorage.getItem(STORAGE_ADVANCES); const localEntries = le ? JSON.parse(le) : [], localAdvances = la ? JSON.parse(la) : []; if (localEntries.length > 0 || localAdvances.length > 0) { entries = localEntries; advances = localAdvances; await saveToFirestore(uid); } } saveLocal(); }
  }
  // --- Handle User Signed Out (Show header message) ---
  function handleUserSignedOut(){ currentUser = null; signedState.style.display = 'none'; usernameModal.style.display = 'none'; authArea.style.display = 'flex'; appContent.style.display = 'none'; loadingScreen.style.display = 'none'; adminMenuBtn.style.display = 'none'; adminModalOverlay.style.display = 'none'; adminResultsEl.style.display = 'none'; adminSearchInput.value = ''; globalHeaderMessage.style.display = 'block'; /* Show message on auth page */ localStorage.removeItem(STORAGE_ENTRIES); localStorage.removeItem(STORAGE_ADVANCES); localStorage.removeItem('temp_total_hours_for_calc'); loadLocal(); showForm(signinForm); applyAuthLanguageTexts(); render(); }
  
  // --- Auth State Listener ---
  onAuthStateChanged(auth, async (user) => { if(user){ await handleUserSignedIn(user); } else { handleUserSignedOut(); }});
  // --- Sign In/Out Buttons ---
  googleSignInBtn.addEventListener('click', async ()=>{ showLoadingState(); try{ await signInWithPopup(auth, provider); } catch(err){ authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Google sign-in failed. Please ensure popups are allowed.'; handleUserSignedOut(); }});
  signOutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); } catch(err){ console.error(err); }});
  // --- Update duration preview ---
  function updatePreview(){ const s=startEl.value, e=endEl.value; if(s && e){ const sM=parseHM(s), eM=parseHM(e); if(sM==null||eM==null){ previewEl.textContent = translations[currentLang].duration_default; return; } let diff=eM - sM; if(diff<0) diff+=24*60; previewEl.textContent = `Duration: ${fmtHM(diff)} (${computeRounded(diff).toFixed(2)}h)` } else { previewEl.textContent = translations[currentLang].duration_default } }
  [startEl,endEl].forEach(i=>i.addEventListener('input', updatePreview));
  // --- Render the main UI ---
  function render(){
    if (!currentUser) { authArea.style.display = 'flex'; appContent.style.display = 'none'; return; }
    entriesBody.innerHTML = ''; let totalHours = 0;
    const filteredEntries = entries.filter(r=>{ const d = new Date(r.date); return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth; });
    filteredEntries.sort((a,b)=> a.date < b.date ? 1 : a.date > b.date ? -1 : b.id - a.id);
    const t = translations[currentLang]; const dayOffText = t.day_off_text || 'Day Off';
    for(const row of filteredEntries){ const tr = document.createElement('tr'); if(row.isDayOff) tr.classList.add('day-off'); const start = row.isDayOff? dayOffText : row.start; const end = row.isDayOff? dayOffText : row.end; const duration = row.isDayOff? dayOffText : row.duration; const rounded = row.isDayOff? 0 : row.rounded; const taskDisplay = row.isDayOff ? dayOffText : row.task || ''; tr.innerHTML = `<td>${row.date}</td><td>${start}</td><td>${end}</td><td>${duration}</td><td>${rounded.toFixed(2)}</td><td class="${row.isDayOff? 'day-off-task':''}">${taskDisplay}</td><td class="actions">${row.isDayOff? `<button class="chip del" data-type="entry" data-id="${row.id}">${t.del}</button>` : `<button class="chip edit" data-id="${row.id}">${t.edit}</button><button class="chip del" data-type="entry" data-id="${row.id}">${t.del}</button>`}</td>`; entriesBody.appendChild(tr); totalHours += rounded; }
    localStorage.setItem('temp_total_hours_for_calc', totalHours.toFixed(2));
    advancesBody.innerHTML = '';
    const filteredAdvances = advances.filter(a => { const d = new Date(a.date); return d.getFullYear() === selectedYear && d.getMonth() === selectedMonth; });
    filteredAdvances.sort((a, b) => a.date < b.date ? 1 : a.date > b.date ? -1 : b.id - a.id);
    for (const row of filteredAdvances) { const tr = document.createElement('tr'); tr.innerHTML = `<td>${row.date}</td><td>${row.amount.toFixed(2)} ${t.currency}</td><td>${row.note || ''}</td><td class="actions"><button class="chip del" data-type="advance" data-id="${row.id}">${t.del}</button></td>`; advancesBody.appendChild(tr); }
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang]; monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    applyLanguageTexts();
  }
  // --- Save All Data ---
  async function saveAll(){ localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(entries)); localStorage.setItem(STORAGE_ADVANCES, JSON.stringify(advances)); render(); if(currentUser){ await saveToFirestore(currentUser.uid); }}
  // --- Add/Update Entry ---
  addBtn.addEventListener('click', async ()=>{ const date = dateEl.value; const s = startEl.value; const e = endEl.value; const task = taskEl.value.trim(); if(!date || !s || !e) return alert(translations[currentLang].alert_fill); const sM = parseHM(s), eM = parseHM(e); if(sM==null||eM==null) return alert('Invalid time'); let diff = eM - sM; if(diff<0) diff += 24*60; const formatted = fmtHM(diff); const rounded = computeRounded(diff); if(editId){ const idx = entries.findIndex(x=>x.id===editId); if(idx>-1){ entries[idx] = { id: editId, date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false }; editId = null; addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; } } else { entries.push({ id: Date.now(), date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false }); } formReset(); await saveAll(); });
  
  // --- Reset Entry Form (FIXED: Don't reset date) ---
  function formReset(){ 
    // Date input is NOT reset, so you can add multiple entries for the same day
    startEl.value=''; endEl.value=''; taskEl.value=''; 
    taskEl.placeholder = translations[currentLang].task_placeholder; 
    previewEl.textContent = translations[currentLang].duration_default; 
    addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; editId = null; 
  }
  
  // --- Add Day Off ---
  dayOffBtn.addEventListener('click', async ()=>{ const date = dateEl.value; if(!date) return alert(translations[currentLang].alert_fill); const dayOffText = translations[currentLang].day_off_text || 'Day Off'; const existingDayOff = entries.some(x => x.date === date && x.isDayOff); if (existingDayOff) { entries = entries.filter(x => !(x.date === date && x.isDayOff)); entries = entries.filter(x => x.date !== date); } else { const regularEntries = entries.filter(x => x.date === date && !x.isDayOff); if (regularEntries.length > 0 && !confirm(`There are ${regularEntries.length} entries on ${date}. Delete them and mark as Day Off?`)) return; entries = entries.filter(x => x.date !== date); entries.push({ id: Date.now(), date, start:'', end:'', duration:'00:00', rounded:0, task: dayOffText, isDayOff:true }); } formReset(); await saveAll(); });
  // --- Unified Edit/Delete Listener ---
  appContent.addEventListener('click', async (ev) => { if (ev.target.classList.contains('edit')) { const idStr = ev.target.getAttribute('data-id'); if (!idStr) return; const id = Number(idStr); const idx = entries.findIndex(x => x.id === id); if (idx === -1) return; const r = entries[idx]; if (r.isDayOff) return alert('Cannot edit Day Off'); dateEl.value = r.date; startEl.value = r.start; endEl.value = r.end; taskEl.value = r.task; editId = id; addBtn.textContent = 'üíæ Save'; updatePreview(); window.scrollTo({ top: 0, behavior: 'smooth' }); } if (ev.target.classList.contains('del')) { const idStr = ev.target.getAttribute('data-id'); const type = ev.target.getAttribute('data-type'); if (!idStr || !type || !confirm('Delete this item?')) return; const id = Number(idStr); if (type === 'entry') { entries = entries.filter(x => x.id !== id); } else if (type === 'advance') { advances = advances.filter(x => x.id !== id); } await saveAll(); } });
  // --- Export CSV ---
  exportBtn.addEventListener('click', ()=>{ const filteredEntries = entries.filter(r=>{ const d=new Date(r.date); return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth; }); const filteredAdvances = advances.filter(a=>{ const d=new Date(a.date); return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth; }); if(filteredEntries.length===0 && filteredAdvances.length===0) return alert('No data to export for this month'); const t = translations['en']; const currentT = translations[currentLang]; const userName = currentUser ? currentUser.displayName || 'Unknown User' : 'Guest'; const userLabel = currentT.csv_user_label || 'User Name'; const totalHoursValue = parseFloat(localStorage.getItem('temp_total_hours_for_calc') || '0'); const grossEarnings = (totalHoursValue * HOURLY_RATE); let totalAdvance = 0; filteredAdvances.forEach(a => totalAdvance += a.amount); const netEarnings = grossEarnings - totalAdvance; const currency = currentT.currency || '‡∏ø'; const entryHeader=['Date','Start','End','Duration','Rounded Hours','Task']; let csv = `${userLabel}:,${userName}\n`; csv += `Month:,${monthLabel.textContent}\n\n`; csv += `Entries:\n`; csv += entryHeader.join(',') + '\n'; filteredEntries.forEach(r=> csv += [r.date, r.isDayOff? t.day_off_text : r.start, r.isDayOff? t.day_off_text : r.end, r.isDayOff? t.day_off_text : r.duration, r.isDayOff? '0.00': r.rounded.toFixed(2), `"${(r.task||'').replace(/"/g,'""')}"`].join(',') + '\n'); csv += `\n`; csv += `${currentT.advance_title}:\n`; csv += `${currentT.th_advance_date},${currentT.th_advance_amount},${currentT.th_advance_note}\n`; filteredAdvances.forEach(a => csv += [a.date, a.amount.toFixed(2), `"${(a.note||'').replace(/"/g,'""')}"`].join(',') + '\n'); csv += `\n`; csv += `Summary:\n`; csv += `${currentT.total_label},${totalHoursValue.toFixed(2)}\n`; csv += `${currentT.gross_earnings},${grossEarnings.toFixed(2)} ${currency}\n`; csv += `${currentT.total_advance},${totalAdvance.toFixed(2)} ${currency}\n`; csv += `${currentT.net_earnings},${netEarnings.toFixed(2)} ${currency}\n`; const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `VannTrack_${userName.replace(/\s/g, '_')}_${selectedYear}-${String(selectedMonth+1).padStart(2,'0')}.csv`; document.body.appendChild(a); a.click(); a.remove(); });
  // --- Print Button ---
  printBtn.addEventListener('click', ()=> window.print());
  // --- Month Navigation ---
  prevMonthBtn.addEventListener('click', ()=>{ selectedMonth--; if(selectedMonth<0){ selectedMonth=11; selectedYear--; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  nextMonthBtn.addEventListener('click', ()=>{ selectedMonth++; if(selectedMonth>11){ selectedMonth=0; selectedYear++; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  todayMonthBtn.addEventListener('click', ()=>{ const now=new Date(); selectedYear=now.getFullYear(); selectedMonth=now.getMonth(); localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); dateEl.valueAsDate = now; advanceDateEl.valueAsDate = now; render(); }); // FIXED: Also reset date inputs on Today
  // --- Theme Toggle (Both Pages) ---
  function applyTheme(){ const newTheme = localStorage.getItem(THEME) || 'dark'; if(newTheme==='light'){ document.body.classList.add('light-mode'); themeToggle.textContent='‚òÄÔ∏è'; authThemeToggle.textContent='‚òÄÔ∏è'; } else { document.body.classList.remove('light-mode'); themeToggle.textContent='üåô'; authThemeToggle.textContent='üåô'; } }
  themeToggle.addEventListener('click', ()=>{ const current = document.body.classList.contains('light-mode'); localStorage.setItem(THEME, current ? 'dark' : 'light'); applyTheme(); });
  authThemeToggle.addEventListener('click', ()=>{ const current = document.body.classList.contains('light-mode'); localStorage.setItem(THEME, current ? 'dark' : 'light'); applyTheme(); });
  // --- Apply Language Texts (Main App) ---
  function applyLanguageTexts(){
    const t = translations[currentLang]; const currency = t.currency || '‡∏ø';
    document.getElementById('app-title').textContent = t.app_title; document.getElementById('app-sub').textContent = t.sub;
    document.getElementById('modal-title').textContent = t.modal_title; document.getElementById('modal-subtitle').textContent = t.modal_subtitle; document.getElementById('save-username-btn').textContent = t.save_name;
    signOutBtn.textContent = t.sign_out_btn;
    dateLabel.textContent = t.date_label; startLabel.textContent = t.in_label; endLabel.textContent = t.out_label; taskLabel.textContent = t.task_placeholder; taskEl.placeholder = t.task_placeholder;
    if (currentUser && currentUser.displayName) { 
        signedText.textContent = `${currentUser.displayName}`; // CHANGED
    }
    addBtn.textContent = editId ? 'üíæ Save' : '‚ûï ' + t.add_entry; dayOffBtn.textContent = 'üèñÔ∏è ' + t.add_dayoff;
    exportBtn.textContent = 'üíæ ' + t.export_csv; printBtn.textContent = 'üñ®Ô∏è ' + t.print;
    if (!startEl.value || !endEl.value) { previewEl.textContent = t.duration_default; }
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang] || 'en-US'; monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    advanceTitle.textContent = t.advance_title; advanceDateLabel.textContent = t.advance_date_label; advanceAmountLabel.textContent = t.advance_amount_label; advanceNoteLabel.textContent = t.advance_note_label; advanceNoteEl.placeholder = t.advance_note_placeholder; addAdvanceBtn.textContent = '‚ûï ' + t.add_advance;
    thDate.textContent = t.th_date; thStart.textContent = t.th_start; thEnd.textContent = t.th_end; thDuration.textContent = t.th_duration; thRounded.textContent = t.th_rounded; thTask.textContent = t.th_task; thActions.textContent = t.th_actions; thAdvanceDate.textContent = t.th_advance_date; thAdvanceAmount.textContent = t.th_advance_amount; thAdvanceNote.textContent = t.th_advance_note; thAdvanceActions.textContent = t.th_advance_actions;
    updateTotalHoursVisibility(); updateEarningsDisplay();
  }
  // --- Apply Language Texts (Auth Page) (REMOVED Phone) ---
  function applyAuthLanguageTexts() {
      const t = translations[currentLang];
      authTitleText.textContent = t.auth_title || 'TheVann Tracker';
      authSigninSub.textContent = t.auth_signin_sub || 'Sign in...';
      authRegisterSub.textContent = t.auth_register_sub || 'Create account...';
      authResetSub.textContent = t.auth_reset_sub || 'Reset password...';
      forgotPasswordLink.textContent = t.forgot_password_link || 'Forgot Password?';
      resetBtn.textContent = t.send_reset_link || 'Send Reset Link';
      backToSigninFromReset.textContent = t.back_to_signin || 'Back to Sign In';
      showRegisterLink.textContent = t.auth_need_account || 'Need an account? Register';
      showSigninLink.textContent = t.auth_have_account || 'Already have an account? Sign In';
      emailTermsFooter.innerHTML = t.auth_terms; // UPDATED
      Array.from(authLangButtons.children).forEach(btn => btn.style.fontWeight = btn.getAttribute('data-lang') === currentLang ? 'bold' : 'normal');
      if(langButtons) Array.from(langButtons.children).forEach(btn => btn.style.fontWeight = btn.getAttribute('data-lang') === currentLang ? 'bold' : 'normal');
  }
  // Language Listeners
  langButtons.addEventListener('click', (ev)=>{ const b=ev.target; const lang=b.getAttribute('data-lang'); if(!lang) return; currentLang = lang; localStorage.setItem(LANG,currentLang); render(); });
  authLangButtons.addEventListener('click', (ev)=>{ const b=ev.target; const lang=b.getAttribute('data-lang'); if(!lang) return; currentLang = lang; localStorage.setItem(LANG,currentLang); applyAuthLanguageTexts(); });
  
  // --- Auth Form Switching Logic (REMOVED Phone) ---
  function showForm(formToShow) { 
    signinForm.style.display = 'none'; registerForm.style.display = 'none'; 
    resetPasswordForm.style.display = 'none'; 
    formToShow.style.display = 'block'; authMessageEl.textContent = ''; 
    applyAuthLanguageTexts(); 
  }
  showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showForm(registerForm); });
  showSigninLink.addEventListener('click', (e) => { e.preventDefault(); showForm(signinForm); });
  forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showForm(resetPasswordForm); });
  backToSigninFromReset.addEventListener('click', (e) => { e.preventDefault(); showForm(signinForm); });
  
  // --- Email/Password Login ---
  signinForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = loginEmailEl.value.trim(); const password = loginPasswordEl.value; authMessageEl.style.color = 'var(--accent)'; authMessageEl.textContent = 'Signing in...'; if (!email || !password) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Please enter email and password.'; return; } try { await signInWithEmailAndPassword(auth, email, password); authMessageEl.textContent = 'Sign in successful! Loading...'; } catch (error) { authMessageEl.style.color = 'var(--danger)'; if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { authMessageEl.textContent = 'Invalid email or password.'; } else { console.error('Login Error:', error); authMessageEl.textContent = 'Error: ' + error.message; } } });
  // --- Email/Password Registration ---
  registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const username = registerUsernameEl.value.trim(); const email = registerEmailEl.value.trim(); const password = registerPasswordEl.value; authMessageEl.style.color = 'var(--accent)'; authMessageEl.textContent = 'Checking...'; if (!username || !email || !password) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Please fill all fields.'; return; } if (password.length < 6) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Password must be >= 6 characters.'; return; } if (username.length < 3) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Username must be >= 3 characters.'; return; } try { if (await isUsernameTaken(username)) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Username taken.'; return; } authMessageEl.textContent = 'Creating account...'; const { user } = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(user, { displayName: username }); await sendEmailVerification(user); const usernameRef = doc(db, 'usernames', username.toLowerCase()); await setDoc(usernameRef, { uid: user.uid }); const userDocRef = doc(db, 'users', user.uid); await setDoc(userDocRef, { username: username, email: email, entries: [], advances: [] }, { merge: true }); authMessageEl.style.color = 'var(--success)'; authMessageEl.textContent = translations[currentLang].reset_email_sent || `Verification email sent to ${email}. Check inbox!`; showForm(signinForm); registerUsernameEl.value = ''; registerEmailEl.value = ''; registerPasswordEl.value = ''; } catch (error) { authMessageEl.style.color = 'var(--danger)'; if (error.code === 'auth/email-already-in-use') { authMessageEl.textContent = 'Email already registered.'; } else if (error.code === 'auth/weak-password') { authMessageEl.textContent = 'Password too weak.'; } else { console.error('Registration Error:', error); authMessageEl.textContent = 'Error: ' + error.message; } } });
  // --- Password Reset Logic ---
  resetPasswordForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = resetEmailEl.value.trim(); const t = translations[currentLang]; authMessageEl.textContent = ''; if (!email) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = t.reset_fill_email || 'Please enter your email address.'; return; } authMessageEl.style.color = 'var(--accent)'; authMessageEl.textContent = 'Sending reset email...'; try { await sendPasswordResetEmail(auth, email); authMessageEl.style.color = 'var(--success)'; authMessageEl.textContent = t.reset_email_sent || 'Password reset email sent! Check your inbox.'; resetEmailEl.value = ''; } catch (error) { authMessageEl.style.color = 'var(--danger)'; console.error('Password Reset Error:', error); if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') { authMessageEl.textContent = 'Error: Email not found or invalid.'; } else { authMessageEl.textContent = 'Error: ' + error.message; } } });
  
  // --- Phone Auth Logic (REMOVED) ---
  
  // --- Admin Panel Search (UID) ---
  adminSearchBtn.addEventListener('click', async () => { const searchUid = adminSearchInput.value.trim(); if (!searchUid) return; adminResultsEl.style.display = 'block'; adminResultsEl.innerHTML = 'Searching...'; const t = translations[currentLang]; const currency = t.currency || '‡∏ø'; try { const userRef = doc(db, 'users', searchUid); const userSnap = await getDoc(userRef); if (!userSnap.exists()) { adminResultsEl.innerHTML = `Error: User data not found for UID: ${searchUid}`; return; } const userData = userSnap.data(); const userEntries = userData.entries || []; const userAdvances = userData.advances || []; let totalAllTimeHours = 0; userEntries.forEach(entry => { totalAllTimeHours += entry.rounded || 0; }); let totalAllTimeAdvance = 0; userAdvances.forEach(adv => { totalAllTimeAdvance += adv.amount || 0; }); const totalGrossEarnings = totalAllTimeHours * HOURLY_RATE; const totalNetEarnings = totalGrossEarnings - totalAllTimeAdvance; adminResultsEl.innerHTML = `<strong>User:</strong> <span class="value">${userData.username || 'N/A'}</span><br> <strong>Email/Phone:</strong> <span class="value">${userData.email || (userData.phoneNumber || 'N/A')}</span><br> <strong>Total Entries:</strong> <span class="value">${userEntries.length}</span><br> <strong>Total Advances:</strong> <span class="value">${userAdvances.length}</span><br> <hr style="border-color: rgba(255,255,255,0.1); margin: 8px 0;"> <strong>Total Hours:</strong> <span class="value">${totalAllTimeHours.toFixed(2)}</span><br> <strong>Gross Earnings:</strong> <span class="gross value">${totalGrossEarnings.toFixed(2)} ${currency}</span><br> <strong>Total Advance:</strong> <span class="advance value">${totalAllTimeAdvance.toFixed(2)} ${currency}</span><br> <strong>Net Earnings:</strong> <span class="net value">${totalNetEarnings.toFixed(2)} ${currency}</span>`; } catch (error) { console.error('Admin search error:', error); adminResultsEl.innerHTML = `Error: ${error.message}.`; } });
  // --- Add Advance Payment ---
  addAdvanceBtn.addEventListener('click', async () => { const date = advanceDateEl.value; const amountStr = advanceAmountEl.value; const note = advanceNoteEl.value.trim(); const t = translations[currentLang]; if (!date || !amountStr) { return alert(t.alert_advance_fill); } const amount = parseFloat(amountStr); if (isNaN(amount) || amount <= 0) { return alert(t.alert_advance_amount); } advances.push({ id: Date.now(), date: date, amount: amount, note: note }); advanceDateEl.valueAsDate = new Date(); advanceAmountEl.value = ''; advanceNoteEl.value = ''; await saveAll(); });
  // --- Admin Modal Listeners ---
  adminMenuBtn.addEventListener('click', () => { adminModalOverlay.style.display = 'flex'; });
  adminCloseBtn.addEventListener('click', () => { adminModalOverlay.style.display = 'none'; adminResultsEl.style.display = 'none'; adminSearchInput.value = ''; });
  adminModalOverlay.addEventListener('click', (e) => { if (e.target === adminModalOverlay) { adminModalOverlay.style.display = 'none'; adminResultsEl.style.display = 'none'; adminSearchInput.value = ''; } });
  // --- Total Hours Visibility Toggle Listener ---
  toggleTotalHoursBtn.addEventListener('click', () => { isTotalHoursHidden = !isTotalHoursHidden; localStorage.setItem(TOTAL_HOURS_HIDDEN, isTotalHoursHidden); updateTotalHoursVisibility(); });
  
  // --- Initialize App (FIXED Date) ---
  function init(){
    showLoadingState(); loadLocal();
    
    // Check for saved month first (for month navigation)
    const savedMonth = localStorage.getItem(MONTH);
    if(savedMonth){ 
        try{ const o=JSON.parse(savedMonth); selectedYear=o.y; selectedMonth=o.m; }catch(e){} 
    }
    
    // If no saved month (or first load), default to TODAY
    const now = new Date();
    if(typeof selectedYear === 'undefined'){ 
        selectedYear = now.getFullYear(); 
        selectedMonth = now.getMonth(); 
    }
    
    // ALWAYS set the date inputs to today's date
    dateEl.valueAsDate = now; 
    advanceDateEl.valueAsDate = now;
    
    currentLang = localStorage.getItem(LANG) || 'en';
    isEarningsHidden = localStorage.getItem(EARNINGS_HIDDEN) === 'true';
    isTotalHoursHidden = localStorage.getItem(TOTAL_HOURS_HIDDEN) === 'true';
    applyTheme(); 
    applyAuthLanguageTexts(); // Apply lang to auth page initially
    // setupRecaptcha(); // REMOVED
  }
  init(); // Run initialization

  </script>
</body>
</html>
