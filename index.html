<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>TheVann Track Duration ‚Äî v8 (Google sign-in)</title>
  <meta name="description" content="Track work time with custom rounding, month view, multi-language, dark/light theme, CSV, print-ready and Google sign-in." />

  <style>
    /* ===================================================
    ORIGINAL DESIGN THEME - REFINED COLORS & NICE STYLE
    ===================================================
    */
    :root{
      --bg:#071226; /* Original Dark Blue */
      --card:#0b1724; /* Original Card Color */
      --text:#eaf6fb;
      --muted:#9fb7c6;
      --accent:#06c2d6; /* Primary Blue Accent */
      --accent-2:#2dd4bf; /* Secondary Cyan/Green Accent */
      --success:#16a34a;
      --danger:#ef4444;
      --glass:rgba(255,255,255,0.03);
      --radius:12px;
      --shadow:0 12px 30px rgba(3,8,20,0.6);
      --table-border:rgba(255,255,255,0.04);
      --input-bg:rgba(255,255,255,0.04);
      
      /* Day Off Red Tone */
      --dayoff-bg: rgba(239, 68, 68, 0.15); /* Light red background */
      --dayoff-border: #ef4444; /* Bright red border */
      --dayoff-text: #ffcfcf;
      
      /* NEW EARNINGS COLOR */
      --earnings-color: #fbbd0a; /* Gold/Yellow for money */
      /* NEW ADVANCE COLOR */
      --advance-color: #f472b6; /* Pink/Magenta for advance */
      /* NEW NET EARNINGS COLOR */
      --net-earnings-color: var(--success); /* Green for final amount */
    }
    body.light-mode{
      --bg:#f7fbfc;--card:#fff;--text:#06202a;--muted:#4b5963;--accent:#0ea5a3;--accent-2:#7dd3fc;--glass:rgba(2,6,23,0.03);--shadow:0 8px 20px rgba(2,6,23,0.06);--table-border:rgba(2,6,23,0.06);
      --dayoff-bg: #fff0f0;
      --dayoff-border: #cc3333;
      --dayoff-text: #cc3333;
      --earnings-color: #e38200;
      --advance-color: #db2777;
      --net-earnings-color: var(--success);
    }
    
    /* General Styles */
    *{box-sizing:border-box; transition: all 0.3s ease-in-out;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Roboto,Arial;padding:14px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.02));padding:16px;border-radius:14px;box-shadow:var(--shadow);border:1px solid var(--glass)}
    header.app-head{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:8px; position: relative; padding-top: 50px;} /* Added padding-top for fixed sign-in button */
    .title-wrap{flex:1;min-width:180px}
    h1.title{margin:0;font-size:18px}
    .subtitle{color:var(--muted);font-size:12px;margin-top:4px}

    /* =================================
       UPDATED: AUTH AREA
       Now a flex wrapper for the card
    ================================= */
    .auth-area{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        min-height:calc(100vh - 28px); 
        margin:-14px; 
        padding: 20px;
    }
    .auth-btn{padding:10px 18px;border-radius:18px;border:none;background:#fff;color:#022;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.25); display: flex; align-items: center; max-width: 280px;}
    .auth-btn .google-icon {
        width: 18px; height: 18px; margin-right: 10px; background-size: contain; background-repeat: no-repeat;
        /* Base64 SVG for the standard Google G Logo */
        background-image: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDQ4IDQ4Ij48cGF0aCBmaWxsPSIjNDI4NUY0IiBkPSJNMjQgNWM2LjYgMCAxMC4zIDIuOCAxMi42IDUuM2wtMy43IDMuN2MtMS42LTEuNS0zLjctMi42LTguOS0yLjZtMC04Yy0xMS4yIDAtMTkuOSAxMC4zLTE5LjkgMTAuMy0xLjEgMS0xLjEgMi43IDAgMy44bDIuNiAyLjZjMS4xIDEuMSAxLjEgMi44IDAgMy45bC0xLjYgMS42Yy0xLjEgMS4xLTEuMSAyLjcgMCAzLjhsMy44IDMuOGMxLjEgMS4xIDIuNyAxLjEgMy44IDBsNC4zLTQuM2MxLjEtMS4xIDIuOC0xLjEgMy45IDBsMy44IDMuOGMxLjEgMS4xIDIuNyAxLjEgMy44IDBsNC4zLTQuM2MxLjEtMS4xIDIuOC0xLjEgMy45IDBsMi42LTIuNmMxLjEtMS4xIDEuMS0yLjcgMC0zLjhMNDAuOSAyMmMtMS4xLTEuMS0yLjctMS4xLTMuOCAwTDM0LjMgMTkuMWMtMS4xLTEuMS0yLjgtMS4xLTMuOSAwbC0zLjggMy44Yy0xLjEgMS4xLTIuOCAxLjEtMy45IDBsLTQuMy00LjNjLTEuMS0xLjEtMi43LTEuMS0zLjggMEwyMi40IDEyYy0xLjEtMS4xLTIuNy0xLjEtMy44IDBsLTMuOCAzLjhjLTEuMSAxLjEtMi44IDEuMS0zLjkgMGwtMi42LTIuNmMtMS4xLTEuMS0xLjEtMi43IDAtMy44bDMuNy0zLjdjMS41LTMuNSAzLjktNi4zIDYuMy04LjdsMy43LTMuN2MyLjUtMi41IDUuMy0zLjggOC45LTMuOGg3LjJtMTQuMyAyNmMwIDYuMi0yLjUgMTAuMy01LjMgMTIuNmwtMy43IDMuN2MtMS42IDEuNS0zLjcgMi42LTguOSA1LjNoLS4zODE2IDMyLjcuM2wtLTMuOCAzLjhjLTEuMSAxLjEtMi44IDEuMS0zLjkgMGwtMi42LTIuNmMtMS4xLTEuMS0xLjEtMi43IDAtMy44bDMuNy0zLjdjMS41LTMuNSAzLjktNi4zIDYuMy04LjdsMy43LTMuN2MyLjUtMi41IDUuMy0zLjggOC45LTMuOGg3LjJtMTQuMyAyNmMwIDYuMi0yLjUgMTAuMy01LjMgMTIuNmwtMy43IDMuN2MtMS42IDEuNS0zLjcgMi42LTguOSA1LjNoLTMuOHYtMTkuNWgyLjZjNC4yIDAgNy42IDMgOS40IDYuNUw0MyAyOS42Yy41LjkuNyAxLjguNyAyLjhtLTguMi0zLjVjLS42IDAtMS4yLS4xLTEuNy0uMy0xLjYtLjYtMi41LTEuNS0yLjUtMi45VjI3YzAtMSAuOS0xLjkgMi41LTIuNXYtLjVjMC0uNi0uMy0xLjItLjgtMS43TDM2IDIzLjVjLS41LjUtLjggMS4xLS44IDEuN3YxLjJjMCAuNS4yIDEuMS43IDEuNmw1LjQgNS40YzEuNSAxLjUgMi4yIDMuMyAyLjIgNS44czEuMiA0LjMgMi44IDYuNWwxLjcgMS43Yy45LjkgMi4zIDEuMyAzLjggMS4zVjEzYzAtLjctLjQtMS4zLS45LTEuN2wtMy4xMC0zLjljLS41LS41LTEuMi0uOC0xLjctLjgzNC0uNiAwLTEuMS4zLTEuNy44bC0zLjcgMy43Yy0uNS41LS44IDEuMi0uOCAxLjdWMTdjMCAxIC45IDEuOSAyLjUgMi41di0uNWMwLS42LS4zLTEuMi0uOC0xLjdMMzYgMjQuM2MtLjUuNS0uOCAxLjEtLjggMS43djEuMmMwIC41LjEgMS4xLjcgMS42bDEuNyAxLjdjOS45LS41LS45NC0uMy0xLjctLjgtMi40LTEuNEw5LjkgMTYuN2MtLjUuNS0xLjIuOC0xLjcuOHM9JyIGZpbGw9IiMzQTRFMzkiLz48L3N2Zz4=');
    }
    
    /* SIGNED STATE (FIXED FOR MOBILE/DESTOP) */
    #signedState {
        display: none;
        position: absolute; 
        top: 0px; 
        right: 0px;
        padding: 8px 12px;
        background: var(--card);
        border-bottom-left-radius: 12px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        flex-direction: row;
        align-items: center;
        gap: 8px;
        z-index: 1000;
    }
    .signed-as{color:var(--success);font-weight:700;font-size:13px; white-space: nowrap;}
    .auth-btn.secondary{
      /* FIXED: Sign out button to RED design */
      background: var(--danger); 
      color: #fff; 
      border: 1px solid var(--danger); 
      padding: 4px 8px; 
      font-size: 12px;
      margin-bottom: 0;
    }
    .auth-btn.secondary:hover {
        background: #cc3333;
        border-color: #cc3333;
    }

    /* language + theme */
    .right-controls{display:flex;align-items:center;gap:8px}
    .lang-select{display:flex;gap:6px}
    .lang-select button{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:8px;color:var(--text);cursor:pointer;font-size:13px}
    .toggle{background:transparent;border:1px solid var(--table-border);padding:6px 8px;border-radius:8px;cursor:pointer}

    /* inputs / controls */
    .controls-top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:12px}
    .entry-grid{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .input-group label {
        color: var(--muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 0;
    }
    .input-group {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    input[type=date],input[type=time],input[type=text],input[type=number]{background:transparent;border:1px solid var(--table-border);padding:8px 10px;border-radius:8px;color:var(--text);min-width:120px}
    /* Input number hide arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] { -moz-appearance: textfield; } /* Firefox */

    .preview{color:var(--muted);font-size:13px}

    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#022}
    .ghost{background:transparent;border:1px solid var(--table-border);color:var(--text)}

    /* table */
    .table-wrap{overflow:auto;margin-top:14px;border-radius:10px}
    table{width:100%;border-collapse:collapse;min-width:700px}
    thead th{padding:10px 12px;text-align:left;color:var(--muted);font-size:12px;text-transform:uppercase;border-bottom:1px solid var(--table-border)}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--table-border)}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}
    
    /* DAY OFF Style */
    tr.day-off {
        background: var(--dayoff-bg) !important; 
        color: var(--dayoff-text) !important;
        font-weight: 600; 
        border: 1px solid var(--dayoff-border) !important; 
    }
    tr.day-off td {
        font-style: italic;
        border-bottom: 1px solid var(--dayoff-border) !important;
        padding: 10px 12px;
    }
    tr.day-off td:first-child::before {
        content: "üö® "; 
        margin-right: 5px;
    }

    .actions{display:flex;gap:8px}
    .chip{padding:6px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .chip.edit{background:var(--success);color:#fff}
    .chip.del{background:var(--danger);color:#fff}

    .footer{display:flex;justify-content:flex-end;margin-top:12px; display: none;} /* HIDDEN */
    .total-card{background:var(--input-bg);padding:10px 15px;border-radius:8px;color:var(--text);font-weight:700; font-size: 15px;}
    .total-card span { color: var(--accent); font-size: 16px;}
    
    /* UPDATED: Earnings Display Area */
    #earnings-display {
        background: var(--input-bg);
        padding: 10px 15px;
        border-radius: 8px;
        color: var(--text);
        font-weight: 700;
        font-size: 15px;
        border: 1px solid var(--table-border);
        line-height: 1.6; /* Add some spacing */
    }
    #earnings-display div {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #earnings-amount-gross { color: var(--earnings-color); font-weight: 800; font-size: 16px; }
    #earnings-amount-advance { color: var(--advance-color); font-weight: 800; font-size: 16px; }
    #earnings-amount-net { color: var(--net-earnings-color); font-weight: 800; font-size: 18px; border-top: 1px dashed var(--muted); padding-top: 5px; margin-top: 5px;}
    
    /* Toggle button position */
    .earnings-toggle {
        background: transparent; border: none; cursor: pointer; font-size: 18px; padding: 0 2px;
        color: var(--muted); line-height: 1; margin-left: 8px;
    }
    .earnings-toggle:hover { color: var(--text); }
    
    /* Position earnings wrapper */
    .controls-top .earnings-wrapper { order: 3; margin-left: 8px; }

    /* =================================
       NEW: Cool & Clean Auth Card Design
    ================================= */
    .auth-card {
        background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--glass);
        padding: 24px 28px; width: 100%; max-width: 400px; animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .auth-card .auth-title { text-align: center; font-size: 24px; margin-top: 0; margin-bottom: 20px; color: var(--text); }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--table-border); margin-bottom: 24px; }
    .auth-tab { flex: 1; background: transparent; border: none; color: var(--muted); padding: 12px 10px;
        font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent;
        margin-bottom: -1px; transition: all 0.2s ease; }
    .auth-tab.active { color: var(--accent-2); border-bottom-color: var(--accent-2); }
    .auth-tab:not(.active):hover { color: var(--text); }
    .auth-pane-sub { font-size: 14px; color: var(--muted); text-align: center; margin-top: 0; margin-bottom: 20px; }
    .auth-card .auth-btn { width: 100%; max-width: 100%; justify-content: center; }
    .auth-card .input-group { width: 100%; max-width: 100%; }
    .auth-card .input-group input,
    .auth-area input[type=email], .auth-area input[type=password], .auth-area input[type=text] {
        width: 100%; min-width: unset; background: var(--input-bg);
    }
    .auth-btn.primary { justify-content: center; }
    .auth-divider { display: flex; align-items: center; text-align: center; color: var(--muted);
        font-size: 12px; font-weight: 600; margin: 20px 0; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--table-border); }
    .auth-divider span { padding: 0 10px; }
    /* =================================
       END of New Auth CSS
    ================================= */
    
    /* NEW: Admin Panel Style */
    #admin-panel { margin-top: 16px; background: linear-gradient(180deg, var(--danger), #a13030); border-color: #ff6060; }
    #admin-panel h2 { margin-top: 0; color: #fff; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px; }
    #admin-panel .input-group label { color: #ffcfcf; }
    #admin-panel .input-group input { background: var(--input-bg); }
    #admin-results { margin-top: 15px; background: var(--bg); padding: 10px; border-radius: 8px; display:none; color: var(--text); line-height: 1.6; }
    #admin-results strong { color: var(--accent-2); }

    /* NEW: Advance Payment Section */
    .advance-section { margin-top: 20px; border-top: 1px solid var(--table-border); padding-top: 20px;}
    .advance-section h3 { margin-top: 0; color: var(--advance-color); }
    .advance-grid { display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px;}
    .advance-grid .input-group { flex: 1; min-width: 120px; }
    .advance-grid .input-group.amount-group { flex: 0 1 150px; } /* Amount field smaller */
    .advance-grid .input-group.note-group { flex: 2; } /* Note field larger */
    .btn.advance-btn { background: var(--advance-color); color: #fff; }
    
    /* Style for advances table */
    #advances-table { min-width: 500px; } /* Adjust min-width as needed */
    #advances-table td:nth-child(2) { color: var(--advance-color); font-weight: 700; } /* Amount column style */


    /* GENERAL MOBILE FIXES */
    @media(max-width:640px){
      .entry-grid, .advance-grid {flex-direction:column; align-items:stretch;} /* Make grids stack on mobile */
      .controls-top{flex-direction:column; align-items:stretch; gap: 8px;}
      .controls-top > div { flex-wrap: nowrap !important; }
      
      .total-card { order: 1; margin-bottom: 5px; } 
      .controls-top .earnings-wrapper { order: 2; margin-left: 0; margin-bottom: 5px; width: 100%;} 
      .controls-top div:last-child { order: 3; margin-left: 0 !important; }

      input[type=date],input[type=time],input[type=text],input[type=number],.btn,.total-card, #earnings-display{width:100%; min-width: unset;}
      .input-group { width: 100%; }
      table{min-width:600px}
      #advances-table { min-width: 400px; } /* Adjust advances table for mobile */
      
      /* MOBILE HEADER FIX */
      header.app-head { padding-top: 50px; }
      #signedState { position: fixed; top: 0; left: 0; width: 100%; border-radius: 0; border-bottom: 1px solid var(--table-border);
          box-shadow: 0 1px 5px rgba(0,0,0,0.2); justify-content: flex-end; }
    }

    @media print{
      @page{size:A4 landscape;margin:12mm}
      body,html{background:#fff;color:#000}
      .card{background:#fff;box-shadow:none;border:none}
      .controls-top,.entry-grid,.advance-grid,button,[class*="chip"],#auth-area,#loading-screen,.right-controls,#signedState,#admin-panel{display:none} /* Hide advance input */
      table{min-width:0}
      thead th,tbody td{border:1px solid #ccc;padding:8px}
      th{background:#f2f2f2}
      #advances-table { margin-top: 20px; } /* Keep advances table visible */
      #earnings-display { border: 1px solid #ccc; padding: 10px; margin-top: 10px;} /* Style earnings for print */
    }
  </style>
</head>
<body>
  <div class="wrap">
    
<div class="auth-area" id="auth-area" style="display:none;">
    <div class="auth-card">
        <h1 class="auth-title">TheVann Tracker</h1>
        
        <div class="auth-tabs">
            <button id="tab-signin" class="auth-tab active">Sign In</button>
            <button id="tab-register" class="auth-tab">Register</button>
        </div>
        
        <div class="auth-panes">
            
            <div id="signin-pane">
                <p class="auth-pane-sub">Sign in with your email or Google.</p>
                
                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="login-email">Email</label>
                    <input id="login-email" type="email" placeholder="you@example.com" />
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="login-password">Password</label>
                    <input id="login-password" type="password" placeholder="Your password" />
                </div>
                <button id="login-btn" class="auth-btn primary" style="width: 100%; max-width: 100%;">Sign In</button>
                
                <div class="auth-divider">
                    <span>OR</span>
                </div>

                <div class="auth-buttons-wrapper">
                    <button id="googleSignIn" class="auth-btn">
                        <div class="google-icon"></div> 
                        Continue with Google
                    </button>
                </div>
            </div>
            
            <div id="register-pane" style="display: none;">
                <p class="auth-pane-sub">Create a new account with your email.</p>
                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="register-username">Username</label>
                    <input id="register-username" type="text" placeholder="Your unique name" />
                </div>
                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="register-email">Email</label>
                    <input id="register-email" type="email" placeholder="you@example.com" />
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="register-password">Password</label>
                    <input id="register-password" type="password" placeholder="Min. 6 characters" />
                </div>
                <button id="register-btn" class="auth-btn primary" style="width: 100%; max-width: 100%; justify-content: center;">Register Account</button>
            </div>

        </div>
        
        <p id="auth-message" style="color:var(--accent); margin-top: 15px; text-align: center; min-height: 20px;"></p>
    
    </div>
</div>
<div id="username-modal" style="display:none;">
        <div id="username-form-card" class="card">
            <h3 id="modal-title">Set Your Display Name</h3>
            <p id="modal-subtitle" style="color:var(--muted); font-size: 14px;">This name will be used in reports.</p>
            <input id="username-input-field" type="text" placeholder="Your Name or Alias" required style="width: 100%; margin-bottom: 15px;" />
            <button id="save-username-btn" class="primary btn" style="width: 100%;">Save Name</button>
        </div>
    </div>
    <div id="loading-screen" class="card" style="display:none;">
        <h2 style="margin-top:0;">‚è≥ Loading...</h2>
        <p style="color:var(--muted);">Checking authentication status...</p>
    </div>

    <div class="card" id="app-content" style="display:none;" role="application" aria-labelledby="app-title">
      
      
      <header class="app-head">
        
        <div id="signedState" style="display:none;">
            <div class="signed-as" id="signedText"></div>
            <button id="signOut" class="auth-btn secondary"></button>
        </div>
        <div class="title-wrap">
          <h1 class="title" id="app-title">TheVann Track Duration</h1>
          <div class="subtitle" id="app-sub">Auto rounding, monthly view, multi-language</div>
        </div>

        <div class="right-controls">
          <div class="lang-select" id="lang-buttons" role="tablist" aria-label="Language selector">
            <button data-lang="en">üá∫üá∏ EN</button>
            <button data-lang="my">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨</button>
            <button data-lang="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="toggle" id="theme-toggle" title="Toggle theme">üåô</div>
          </div>
        </div>
      </header>

      <div id="admin-panel" class="card" style="display:none;">
          <h2>Admin Panel</h2>
          <div class="input-group" style="margin-bottom: 10px;">
            <label for="admin-search-uid">Search User by User ID (UID)</label>
            <input id="admin-search-uid" type="text" placeholder="Enter exact User ID..." />
          </div>
          <button id="admin-search-btn" class="primary btn" style="background: #fff; color: #b91c1c; border: none;">Search User Hours</button>

          <div id="admin-results" style="display:none;"></div>
      </div>
      <div class="controls-top">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prev-month" class="ghost btn">‚óÄ</button>
          <div id="month-label" style="font-weight:700;min-width:160px;text-align:center;">Month</div>
          <button id="next-month" class="ghost btn">‚ñ∂</button>
          <button id="today-month" class="ghost btn">üóìÔ∏è Today</button>
        </div>
        
        <div class="total-card" id="total-header">Total Rounded Hours: <span id="total">0.00</span></div>
        
        <div class="earnings-wrapper">
            <div id="earnings-display">
                </div>
        </div>
        
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="export-csv" class="ghost btn">üíæ Export CSV</button>
          <button id="print-btn" class="ghost btn">üñ®Ô∏è Print</button>
        </div>
      </div>

      <div class="entry-grid" style="margin-top:12px">
        <div class="input-group">
            <label id="date-label" for="date-input">Date</label>
            <input id="date-input" type="date" />
        </div>
        <div class="input-group">
            <label id="start-label" for="start-input">IN</label>
            <input id="start-input" type="time" />
        </div>
        <div class="input-group">
            <label id="end-label" for="end-input">OUT</label>
            <input id="end-input" type="time" />
        </div>
        <div class="input-group" style="flex-grow: 1;">
            <label id="task-label" for="task-input">Task / notes (optional)</label>
            <input id="task-input" type="text" placeholder="" />
        </div>
        <div class="preview" id="preview" style="align-self: flex-end;">Duration: 00:00 (0.00h)</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="add-btn" class="primary btn">‚ûï Add Entry</button>
          <button id="dayoff-btn" class="ghost btn">üèñÔ∏è Day Off</button>
        </div>
      </div>
      
      <div class="table-wrap">
        <table id="entries-table" aria-describedby="month-label">
          <thead>
            <tr>
              <th id="th-date">Date</th>
              <th id="th-start">Start</th>
              <th id="th-end">End</th>
              <th id="th-duration">Duration (H:M)</th>
              <th id="th-rounded">Rounded (hrs)</th>
              <th id="th-task">Task</th>
              <th class="actions" id="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody id="entries-body"></tbody>
        </table>
      </div>
      
      <div class="advance-section">
          <h3 id="advance-title">·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä±·Äô·Äª·Ä¨·Ä∏ (Advances)</h3>
          <div class="advance-grid">
              <div class="input-group">
                  <label id="advance-date-label" for="advance-date">Date</label>
                  <input id="advance-date" type="date" />
              </div>
              <div class="input-group amount-group">
                  <label id="advance-amount-label" for="advance-amount">Amount</label>
                  <input id="advance-amount" type="number" placeholder="0.00" step="0.01" />
              </div>
              <div class="input-group note-group">
                  <label id="advance-note-label" for="advance-note">Note (optional)</label>
                  <input id="advance-note" type="text" placeholder="" />
              </div>
              <button id="add-advance-btn" class="btn advance-btn">‚ûï Add Advance</button>
          </div>
          <div class="table-wrap">
              <table id="advances-table">
                  <thead>
                      <tr>
                          <th id="th-advance-date">Date</th>
                          <th id="th-advance-amount">Amount</th>
                          <th id="th-advance-note">Note</th>
                          <th class="actions" id="th-advance-actions">Actions</th>
                      </tr>
                  </thead>
                  <tbody id="advances-body"></tbody>
              </table>
          </div>
      </div>
      <div class="footer" style="display:none;">
        <div class="total-card">Total Rounded Hours: <span id="total-footer">0.00</span></div>
      </div>
    </div>
  </div>

  <script type="module">
  // --- Firebase imports (modular) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // UPDATED: Added methods for Email/Pass login and register
  import { 
    getAuth, 
    GoogleAuthProvider, 
    signInWithPopup, 
    signOut, 
    onAuthStateChanged, 
    updateProfile, 
    createUserWithEmailAndPassword, 
    sendEmailVerification, 
    signInWithEmailAndPassword 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";

  // --- Your confirmed Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyBPt8cZMMW6gs8TLV-7EEvpJJVZ33DH23k",
    authDomain: "thevanntrackduration-81ee0.firebaseapp.com",
    projectId: "thevanntrackduration-81ee0",
    storageBucket: "thevanntrackduration-81ee0.firebasestorage.app",
    messagingSenderId: "56786707859",
    appId: "1:56786707859:web:75be757ceb95604984f466",
    measurementId: "G-QNG2F09LWL"
  };

  // init firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics?.(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  // --- CONSTANTS ---
  const HOURLY_RATE = 40.00; // 40 Baht per hour
  
  // ===================================================
  // === ADMIN STEP: PASTE YOUR UID HERE ===
  // Find this in Firebase Console > Authentication > Users
  // (After logging in once with vnoon698@gmail.com)
  const ADMIN_UID = 'h1OJyFLAFDRWgwiZxf2G1rbIapl1'; // <-- YOUR ADMIN UID IS HERE!
  // ===================================================
  
  // --- DOM ---
  const googleSignInBtn = document.getElementById('googleSignIn');
  const signedState = document.getElementById('signedState');
  const signedText = document.getElementById('signedText');
  const signOutBtn = document.getElementById('signOut');
  
  // Username Modal DOM
  const usernameModal = document.getElementById('username-modal');
  const usernameInputField = document.getElementById('username-input-field');
  const saveUsernameBtn = document.getElementById('save-username-btn');

  // New DOM elements for content hiding
  const appContent = document.getElementById('app-content');
  const loadingScreen = document.getElementById('loading-screen');
  const authArea = document.getElementById('auth-area'); // Reference to the main auth area
  
  // UPDATED: Tabbed Auth DOM
  const signinPane = document.getElementById('signin-pane');
  const registerPane = document.getElementById('register-pane');
  const tabSigninBtn = document.getElementById('tab-signin');
  const tabRegisterBtn = document.getElementById('tab-register');
  
  // NEW: Login form inputs
  const loginEmailEl = document.getElementById('login-email');
  const loginPasswordEl = document.getElementById('login-password');
  const loginBtn = document.getElementById('login-btn');
  
  // NEW: Registration form inputs
  const registerUsernameEl = document.getElementById('register-username');
  const registerEmailEl = document.getElementById('register-email');
  const registerPasswordEl = document.getElementById('register-password');
  const registerBtn = document.getElementById('register-btn');
  const authMessageEl = document.getElementById('auth-message');
  
  // UPDATED: Admin Panel DOM (Search by UID)
  const adminPanel = document.getElementById('admin-panel');
  const adminSearchBtn = document.getElementById('admin-search-btn');
  const adminSearchInput = document.getElementById('admin-search-uid'); // Changed ID
  const adminResultsEl = document.getElementById('admin-results');

  // App DOM (Entries)
  const dateEl = document.getElementById('date-input');
  const startEl = document.getElementById('start-input');
  const endEl = document.getElementById('end-input');
  const taskEl = document.getElementById('task-input');
  const previewEl = document.getElementById('preview');
  const addBtn = document.getElementById('add-btn');
  const dayOffBtn = document.getElementById('dayoff-btn');
  const entriesBody = document.getElementById('entries-body');
  
  const totalHeaderEl = document.getElementById('total-header'); 
  const totalEl = totalHeaderEl.querySelector('#total'); 
  
  // UPDATED: Earnings display area and toggle button
  const earningsDisplay = document.getElementById('earnings-display');
  // Removed label/amount/toggle specific vars here, will populate dynamically
  const toggleEarningsBtn = document.getElementById('toggle-earnings'); // Only keep toggle button ref
  
  const exportBtn = document.getElementById('export-csv');
  const printBtn = document.getElementById('print-btn');
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  const todayMonthBtn = document.getElementById('today-month');
  const monthLabel = document.getElementById('month-label');
  const langButtons = document.getElementById('lang-buttons');
  const themeToggle = document.getElementById('theme-toggle');

  // Input Labels for dynamic translation (Entries)
  const dateLabel = document.getElementById('date-label');
  const startLabel = document.getElementById('start-label');
  const endLabel = document.getElementById('end-label');
  const taskLabel = document.getElementById('task-label');

  // NEW: Advance Payment DOM
  const advanceDateEl = document.getElementById('advance-date');
  const advanceAmountEl = document.getElementById('advance-amount');
  const advanceNoteEl = document.getElementById('advance-note');
  const addAdvanceBtn = document.getElementById('add-advance-btn');
  const advancesBody = document.getElementById('advances-body');
  const advanceTitle = document.getElementById('advance-title');
  const advanceDateLabel = document.getElementById('advance-date-label');
  const advanceAmountLabel = document.getElementById('advance-amount-label');
  const advanceNoteLabel = document.getElementById('advance-note-label');
  
  // Table Header IDs for translation
  const thDate = document.getElementById('th-date');
  const thStart = document.getElementById('th-start');
  const thEnd = document.getElementById('th-end');
  const thDuration = document.getElementById('th-duration');
  const thRounded = document.getElementById('th-rounded');
  const thTask = document.getElementById('th-task');
  const thActions = document.getElementById('th-actions');
  const thAdvanceDate = document.getElementById('th-advance-date');
  const thAdvanceAmount = document.getElementById('th-advance-amount');
  const thAdvanceNote = document.getElementById('th-advance-note');
  const thAdvanceActions = document.getElementById('th-advance-actions');


  // keys
  const STORAGE_ENTRIES = 'vann_v8_entries'; // Renamed
  const STORAGE_ADVANCES = 'vann_v8_advances'; // New
  const THEME = 'vann_v8_theme';
  const LANG = 'vann_v8_lang';
  const MONTH = 'vann_v8_month';
  const EARNINGS_HIDDEN = 'vann_v8_earnings_hidden'; // For gross earnings toggle

  // translations 
  const translations = {
    en: { 
      // Existing
      app_title:'TheVann Track Duration', sub:'Auto rounding, monthly view, multi-language', add_entry:'Add Entry', add_dayoff:'Day Off', export_csv:'Export CSV', print:'Print', duration_default:'Duration: 00:00 (0.00h)', total_label:'Total Rounded Hours', alert_fill:'Please fill Date, Start and End.', 
      edit: '‚úèÔ∏è Edit', del: 'üóëÔ∏è Delete', day_off_text: 'Day Off', date_label: 'Date', in_label: 'IN', out_label: 'OUT', task_placeholder: 'Task / notes (optional)',
      csv_user_label: 'User Name', modal_title: 'Set Your Display Name', modal_subtitle: 'This name will be used in reports.', save_name: 'Save Name', sign_out_btn: 'Sign out',
      earnings_label: 'Total Earnings', currency: '‡∏ø', // Used for gross
      // Table Headers
      th_date: 'Date', th_start: 'Start', th_end: 'End', th_duration: 'Duration', th_rounded: 'Rounded (hrs)', th_task: 'Task', th_actions: 'Actions',
      // New Advance Feature
      advance_title: 'Salary Advances', advance_date_label: 'Date', advance_amount_label: 'Amount', advance_note_label: 'Note (optional)', advance_note_placeholder: 'Reason for advance...', add_advance: 'Add Advance', 
      th_advance_date: 'Date', th_advance_amount: 'Amount', th_advance_note: 'Note', th_advance_actions: 'Actions',
      alert_advance_fill: 'Please fill Date and Amount for advance.', alert_advance_amount: 'Advance amount must be a positive number.',
      // Earnings Display
      gross_earnings: 'Gross Earnings', total_advance: 'Total Advance', net_earnings: 'Net Earnings'
    },
    my: { 
      app_title:'Thevann ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏', sub:'·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Äï·Äê·Ä∫·Äú·Ää·Ä∫·ÄÖ·ÄÆ·ÄÖ·ÄÖ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Åä ·Äú·ÄÖ·Äâ·Ä∫ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·Äô·Äæ·ÄØ·Åä ·Äò·Ä¨·Äû·Ä¨·ÄÖ·ÄÄ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏', add_entry:'·Äô·Äæ·Äê·Ä∫·Äê·Äô·Ä∫·Ä∏·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫', add_dayoff:'·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫', export_csv:'CSV ·Äë·ÄØ·Äê·Ä∫·Äö·Ä∞·Äô·Ää·Ä∫', print:'·Äï·ÄØ·Ä∂·Äî·Äæ·Ä≠·Äï·Ä∫', duration_default:'·ÄÄ·Äº·Ä¨·ÄÅ·Äª·Ä≠·Äî·Ä∫: 00:00 (0.00·Äî·Ä¨·Äõ·ÄÆ)', total_label:'·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·Äï·Äê·Ä∫·Äú·Ää·Ä∫·Äî·Ä¨·Äõ·ÄÆ', alert_fill:'·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤·Åä ·ÄÖ·Äê·ÄÑ·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Ä°·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã',
      edit: '‚úèÔ∏è ·Äï·Äº·ÄÑ·Ä∫·ÄÜ·ÄÑ·Ä∫', del: 'üóëÔ∏è ·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫', day_off_text: '·Äî·Ä¨·Ä∏·Äõ·ÄÄ·Ä∫', date_label: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', in_label: '·Äù·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', out_label: '·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', task_placeholder: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ (·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Äú·Ä≠·ÄØ·Äï·Ä´)',
      csv_user_label: '·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Ä°·Äô·Ää·Ä∫', modal_title: '·Äô·Ä≠·Äô·Ä≠·Ä°·Äô·Ää·Ä∫ ·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·Äï·Ä´', modal_subtitle: '·Ä§·Ä°·Äô·Ää·Ä∫·ÄÄ·Ä≠·ÄØ ·Ä°·ÄÖ·ÄÆ·Äõ·ÄÑ·Ä∫·ÄÅ·Ä∂·ÄÖ·Ä¨·Äô·Äª·Ä¨·Ä∏·Äê·ÄΩ·ÄÑ·Ä∫ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äô·Ää·Ä∫·Åã', save_name: '·Ä°·Äô·Ää·Ä∫·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫', sign_out_btn: '·Äë·ÄΩ·ÄÄ·Ä∫·Äô·Ää·Ä∫',
      earnings_label: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·ÄΩ·Ä±', currency: '‡∏ø', // Used for gross
      // Table Headers
      th_date: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', th_start: '·Äù·ÄÑ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_end: '·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_duration: '·ÄÄ·Äº·Ä¨·ÄÅ·Äª·Ä≠·Äî·Ä∫', th_rounded: '·Äî·Ä¨·Äõ·ÄÆ', th_task: '·Ä°·Äú·ÄØ·Äï·Ä∫', th_actions: '·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫',
      // New Advance Feature
      advance_title: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä±·Äô·Äª·Ä¨·Ä∏', advance_date_label: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', advance_amount_label: '·Äï·Äô·Ä¨·Äè', advance_note_label: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ (·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Äú·Ä≠·ÄØ·Äï·Ä´)', advance_note_placeholder: '·Äë·ÄØ·Äê·Ä∫·Äö·Ä∞·Äû·Ää·Ä∑·Ä∫·Ä°·ÄÄ·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·Ä∫·Ä∏...', add_advance: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±·Äë·Ää·Ä∑·Ä∫·Äô·Ää·Ä∫', 
      th_advance_date: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤', th_advance_amount: '·Äï·Äô·Ä¨·Äè', th_advance_note: '·Äô·Äæ·Äê·Ä∫·ÄÖ·ÄØ', th_advance_actions: '·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫',
      alert_advance_fill: '·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤ ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫ ·Äï·Äô·Ä¨·Äè ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´·Åã', alert_advance_amount: '·ÄÄ·Äº·Ä≠·ÄØ·Äê·ÄÑ·Ä∫·Äë·ÄØ·Äê·Ä∫ ·Äï·Äô·Ä¨·Äè·Äû·Ää·Ä∫ ·Ä°·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·Äî·Ä∫·Ä∏ ·Äñ·Äº·ÄÖ·Ä∫·Äõ·Äï·Ä´·Äô·Ää·Ä∫·Åã',
      // Earnings Display
      gross_earnings: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äù·ÄÑ·Ä∫·ÄÑ·ÄΩ·Ä±', total_advance: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ ·ÄÄ·Äº·Ä≠·ÄØ·Äë·ÄØ·Äê·Ä∫·ÄÑ·ÄΩ·Ä±', net_earnings: '·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äõ·ÄÑ·ÄΩ·Ä±'
    },
    th: { 
      app_title:'‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ß‡∏ô', sub:'‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏î‡∏π‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤', add_entry:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', add_dayoff:'‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', export_csv:'‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV', print:'‡∏û‡∏¥‡∏°‡∏û‡πå', duration_default:'‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: 00:00 (0.00 ‡∏ä‡∏°.)', total_label:'‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©', alert_fill:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å',
      edit: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', del: 'üóëÔ∏è ‡∏•‡∏ö', day_off_text: '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', date_label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', in_label: '‡πÄ‡∏Ç‡πâ‡∏≤', out_label: '‡∏≠‡∏≠‡∏Å', task_placeholder: '‡∏á‡∏≤‡∏ô / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)',
      csv_user_label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', modal_title: '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•', modal_subtitle: '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', save_name: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠', sign_out_btn: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
      earnings_label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°', currency: '‡∏ø', // Used for gross
      // Table Headers
      th_date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', th_start: '‡πÄ‡∏£‡∏¥‡πà‡∏°', th_end: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', th_duration: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', th_rounded: '‡∏ä‡∏°. (‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©)', th_task: '‡∏á‡∏≤‡∏ô', th_actions: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥',
      // New Advance Feature
      advance_title: '‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', advance_date_label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', advance_amount_label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', advance_note_label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', advance_note_placeholder: '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å...', add_advance: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å', 
      th_advance_date: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', th_advance_amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', th_advance_note: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', th_advance_actions: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥',
      alert_advance_fill: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å', alert_advance_amount: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ö‡∏ß‡∏Å',
      // Earnings Display
      gross_earnings: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°', total_advance: '‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', net_earnings: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'
    }
  };

  // state
  let entries = [];
  let advances = []; // New state for advance payments
  let editId = null;
  let selectedYear, selectedMonth;
  let currentLang = localStorage.getItem(LANG) || 'en';
  let currentUser = null; // firebase user object
  let isEarningsHidden = false; // Now applies to gross earnings

  // helpers
  function parseHM(t){ if(!t) return null; const [h,m]=t.split(':').map(Number); if(Number.isNaN(h)||Number.isNaN(m)) return null; return h*60+m; }
  function fmtHM(min){ const h=Math.floor(min/60); const m=min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}` }
  
  // --- Calculate rounded hours based on minutes ---
  function computeRounded(raw){ 
    if(raw<=0) return 0.00; 
    const h=Math.floor(raw/60); const m=raw%60; let H=h; 
    if(m>=0 && m<=29) { return +(H).toFixed(2); } 
    else if(m>=30 && m<=39) { return +(H + 0.5).toFixed(2); } 
    else if(m>=40 && m<=59){ return +(H + 1).toFixed(2); }
    return +(H).toFixed(2); 
  }
  // --------------------------------------------------

  // --- Check if username is already taken in Firestore ---
  async function isUsernameTaken(username) {
      const usernameRef = doc(db, 'usernames', username.toLowerCase());
      const docSnap = await getDoc(usernameRef);
      return docSnap.exists();
  }
  // --------------------------------------------------------

  // --- Update visibility/calculation of earnings (Gross, Advance, Net) ---
  function updateEarningsDisplay() {
      const t = translations[currentLang];
      const currency = t.currency || '‡∏ø';
      
      const totalHours = parseFloat(totalEl.textContent) || 0;
      const grossEarnings = (totalHours * HOURLY_RATE);
      
      // Calculate total advance for the current month
      let totalAdvance = 0;
      const filteredAdvances = advances.filter(a => {
          const d = new Date(a.date);
          return d.getFullYear() === selectedYear && d.getMonth() === selectedMonth;
      });
      filteredAdvances.forEach(a => totalAdvance += a.amount);
      
      const netEarnings = grossEarnings - totalAdvance;

      const hiddenValue = `******** ${currency}`;
      
      earningsDisplay.innerHTML = `
          <div>
              <span>${t.gross_earnings}:</span>
              <span id="earnings-amount-gross">${isEarningsHidden ? hiddenValue : grossEarnings.toFixed(2) + ' ' + currency}</span>
              <button id="toggle-earnings-visibility" class="earnings-toggle" title="Toggle visibility">${isEarningsHidden ? 'üôà' : 'üëÅÔ∏è'}</button>
          </div>
          <div>
              <span>${t.total_advance}:</span>
              <span id="earnings-amount-advance" style="color: var(--advance-color);">${totalAdvance.toFixed(2)} ${currency}</span>
          </div>
          <div>
              <span style="font-weight: 800;">${t.net_earnings}:</span>
              <span id="earnings-amount-net" style="color: var(--net-earnings-color);">${netEarnings.toFixed(2)} ${currency}</span>
          </div>
      `;

      // Re-attach listener for the toggle button inside the dynamic HTML
      const toggleBtn = document.getElementById('toggle-earnings-visibility');
      if (toggleBtn) {
          toggleBtn.addEventListener('click', toggleEarningsVisibility);
      }
  }
  
  // Separate function to handle the toggle click
  function toggleEarningsVisibility() {
      isEarningsHidden = !isEarningsHidden;
      localStorage.setItem(EARNINGS_HIDDEN, isEarningsHidden);
      updateEarningsDisplay(); // Re-render the earnings display
  }
  // ---------------------------------------------

  // --- Local storage functions (Updated for entries and advances) ---
  function saveLocal(){ 
      localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(entries)); 
      localStorage.setItem(STORAGE_ADVANCES, JSON.stringify(advances)); 
      render(); 
  }
  function loadLocal(){ 
      const rawEntries = localStorage.getItem(STORAGE_ENTRIES); 
      entries = rawEntries ? JSON.parse(rawEntries) : []; 
      const rawAdvances = localStorage.getItem(STORAGE_ADVANCES);
      advances = rawAdvances ? JSON.parse(rawAdvances) : [];
  }
  // -----------------------------------------------------------------

  // --- Firestore helper functions (Updated for entries and advances) ---
  // Save user entries AND advances to Firestore
  async function saveToFirestore(uid){
    if(!uid) return;
    try{
      const d = doc(db, 'users', uid);
      // Save both arrays
      await setDoc(d, { entries, advances }, { merge: true }); 
      // console.log('Saved entries and advances to Firestore');
    }catch(err){
      console.error('saveToFirestore error:', err);
    }
  }
  
  // Load user entries AND advances from Firestore
  async function loadFromFirestore(uid){
    if(!uid) return null;
    try{
      const d = doc(db, 'users', uid);
      const snap = await getDoc(d);
      if(snap.exists()){
        const data = snap.data();
        // Return both arrays (or empty arrays if they don't exist)
        return {
            entries: (Array.isArray(data.entries) ? data.entries : []),
            advances: (Array.isArray(data.advances) ? data.advances : [])
        };
      } else {
        // User document doesn't exist, return empty arrays
        return { entries: [], advances: [] }; 
      }
    }catch(err){
      console.error('loadFromFirestore error:', err);
      return null; // Return null on error
    }
  }
  // ------------------------------------------------------------------

  // --- Handle first-time username setup ---
  async function handleUsernameSetup(user) {
    usernameModal.style.display = 'flex';
    usernameInputField.value = user.displayName || (user.email ? user.email.split('@')[0] : 'Your Name');
    const t = translations[currentLang];
    document.getElementById('modal-title').textContent = t.modal_title;
    document.getElementById('modal-subtitle').textContent = t.modal_subtitle;
    document.getElementById('save-username-btn').textContent = t.save_name;
  }
  saveUsernameBtn.addEventListener('click', async () => {
      const newName = usernameInputField.value.trim();
      if (!newName) { alert('Please enter a name.'); return; }
      if (currentUser) {
          try {
              await updateProfile(currentUser, { displayName: newName });
              currentUser.displayName = newName;
              usernameModal.style.display = 'none';
              handleUserSignedIn(currentUser); 
          } catch (error) { console.error('Error updating profile:', error); alert('Failed to save name: ' + error.message); }
      }
  });
  // ----------------------------------------

  // --- UI State Control ---
  function showLoadingState(){
      authArea.style.display = 'none'; appContent.style.display = 'none'; signedState.style.display = 'none';
      usernameModal.style.display = 'none'; loadingScreen.style.display = 'block'; 
      loadingScreen.querySelector('h2').innerHTML = '‚è≥ Loading...';
      loadingScreen.querySelector('p').textContent = 'Checking authentication status...';
  }
  // ------------------------

  // --- Handle User Signed In ---
  async function handleUserSignedIn(user){
    currentUser = user;
    const uid = user.uid;
    
    // --- Check for Email Verification ---
    if (!user.emailVerified && !user.providerData.some(p => p.providerId === 'google.com')) {
        showLoadingState();
        loadingScreen.querySelector('h2').innerHTML = 'Email Verification Required';
        loadingScreen.querySelector('p').textContent = `A verification link was sent to ${user.email}. Please check your inbox and verify your account.`;
        authArea.style.display = 'none'; appContent.style.display = 'none'; signedState.style.display = 'none';
        try { await signOut(auth); } catch(e) { console.error("Sign out error", e); }
        return; 
    }
    
    // --- Check for Display Name ---
    if (!user.displayName || user.displayName === '' || user.displayName.includes('@')) {
        await handleUsernameSetup(user);
        return; 
    }
    
    // --- Proceed if verified and display name is set ---
    signedText.textContent = `Signed in: ${user.displayName}`;
    signedState.style.display = 'flex'; authArea.style.display = 'none';    
    appContent.style.display = 'block'; loadingScreen.style.display = 'none'; 
    
    // --- Show Admin Panel ---
    adminPanel.style.display = (user.uid === ADMIN_UID) ? 'block' : 'none';
    
    // --- Load user data (Entries AND Advances) ---
    const cloudData = await loadFromFirestore(uid);
    if(cloudData === null){ // Firestore error
      console.warn('Could not read from Firestore ‚Äî using local data');
      loadLocal(); // Load both entries and advances from local
    } else { // Firestore data (or empty arrays) received
      entries = cloudData.entries;
      advances = cloudData.advances;
      // Check if local data needs syncing UP (only if cloud was empty but local wasn't)
      if (cloudData.entries.length === 0 && cloudData.advances.length === 0) {
          const rawLocalEntries = localStorage.getItem(STORAGE_ENTRIES);
          const localEntries = rawLocalEntries ? JSON.parse(rawLocalEntries) : [];
          const rawLocalAdvances = localStorage.getItem(STORAGE_ADVANCES);
          const localAdvances = rawLocalAdvances ? JSON.parse(rawLocalAdvances) : [];
          if (localEntries.length > 0 || localAdvances.length > 0) {
              entries = localEntries; // Use local data
              advances = localAdvances;
              await saveToFirestore(uid); // Sync local up to cloud
          }
      }
      saveLocal(); // Sync cloud data down to local storage & render
    } 
    // Initial render is triggered by saveLocal()
  }

  // --- Handle User Signed Out ---
  function handleUserSignedOut(){
    currentUser = null;
    signedState.style.display = 'none'; usernameModal.style.display = 'none'; authArea.style.display = 'flex';   
    appContent.style.display = 'none'; loadingScreen.style.display = 'none'; 
    adminPanel.style.display = 'none'; adminResultsEl.style.display = 'none'; adminSearchInput.value = '';
    
    // --- Clear user-specific data from local storage ---
    localStorage.removeItem(STORAGE_ENTRIES); 
    localStorage.removeItem(STORAGE_ADVANCES);
    
    loadLocal(); // Reset state arrays to empty
    
    // --- Reset auth tabs ---
    if (tabSigninBtn) {
        tabSigninBtn.classList.add('active'); tabRegisterBtn.classList.remove('active');
        signinPane.style.display = 'block'; registerPane.style.display = 'none';
        authMessageEl.textContent = ''; 
    }
    render(); // Re-render (will show auth screen)
  }

  // --- Firebase Auth State Listener ---
  onAuthStateChanged(auth, async (user) => {
    if(user){ await handleUserSignedIn(user); } 
    else { handleUserSignedOut(); }
  });
  // ------------------------------------

  // --- Sign In/Out Button Listeners ---
  googleSignInBtn.addEventListener('click', async ()=>{
    showLoadingState(); 
    try{ await signInWithPopup(auth, provider); }
    catch(err){ alert('Google sign-in failed: ' + err.message); handleUserSignedOut(); }
  });
  signOutBtn.addEventListener('click', async ()=>{
    try{ await signOut(auth); } catch(err){ console.error(err); }
  });
  // ------------------------------------

  // --- Update duration preview ---
  function updatePreview(){ 
      const s=startEl.value, e=endEl.value; 
      if(s && e){ 
          const sM=parseHM(s), eM=parseHM(e); 
          if(sM==null||eM==null){ previewEl.textContent = translations[currentLang].duration_default; return; } 
          let diff=eM - sM; if(diff<0) diff+=24*60; 
          previewEl.textContent = `Duration: ${fmtHM(diff)} (${computeRounded(diff).toFixed(2)}h)` 
      } else { previewEl.textContent = translations[currentLang].duration_default } 
  }
  [startEl,endEl].forEach(i=>i.addEventListener('input', updatePreview));
  // -----------------------------

  // --- Render the main UI (tables, totals, etc.) ---
  function render(){
    // Don't render if user is not logged in
    if (!currentUser) {
        authArea.style.display = 'flex';
        appContent.style.display = 'none';
        return;
    }
      
    // --- Render Entries Table ---
    entriesBody.innerHTML = ''; 
    let totalHours = 0;
    const filteredEntries = entries.filter(r=>{
      const d = new Date(r.date);
      return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth;
    });
    filteredEntries.sort((a,b)=> a.date < b.date ? 1 : a.date > b.date ? -1 : b.id - a.id);
    const t = translations[currentLang]; 
    const dayOffText = t.day_off_text || 'Day Off';
    for(const row of filteredEntries){
      const tr = document.createElement('tr');
      if(row.isDayOff) tr.classList.add('day-off'); 
      const start = row.isDayOff? dayOffText : row.start;
      const end = row.isDayOff? dayOffText : row.end;
      const duration = row.isDayOff? dayOffText : row.duration;
      const rounded = row.isDayOff? 0 : row.rounded;
      const taskDisplay = row.isDayOff ? dayOffText : row.task || '';
      tr.innerHTML = `<td>${row.date}</td><td>${start}</td><td>${end}</td><td>${duration}</td><td>${rounded.toFixed(2)}</td><td class="${row.isDayOff? 'day-off-task':''}">${taskDisplay}</td><td class="actions">${row.isDayOff? `<button class="chip del" data-type="entry" data-id="${row.id}">${t.del}</button>` : `<button class="chip edit" data-id="${row.id}">${t.edit}</button><button class="chip del" data-type="entry" data-id="${row.id}">${t.del}</button>`}</td>`;
      entriesBody.appendChild(tr);
      totalHours += rounded; 
    }
    totalEl.textContent = totalHours.toFixed(2); // Update total hours display
    
    // --- Render Advances Table ---
    advancesBody.innerHTML = '';
    const filteredAdvances = advances.filter(a => {
        const d = new Date(a.date);
        return d.getFullYear() === selectedYear && d.getMonth() === selectedMonth;
    });
    filteredAdvances.sort((a, b) => a.date < b.date ? 1 : a.date > b.date ? -1 : b.id - a.id);
    for (const row of filteredAdvances) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.amount.toFixed(2)} ${t.currency}</td>
            <td>${row.note || ''}</td>
            <td class="actions"><button class="chip del" data-type="advance" data-id="${row.id}">${t.del}</button></td>
        `;
        advancesBody.appendChild(tr);
    }
    
    // --- Update Month Label ---
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang];
    monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    
    // --- Apply Translations and Update Earnings Display ---
    applyLanguageTexts(); 
  }
  // ----------------------------------------------------

  // --- Save data to local storage and Firestore ---
  async function saveAll(){
    // No need to call render() here, saveLocal does it.
    localStorage.setItem(STORAGE_ENTRIES, JSON.stringify(entries)); 
    localStorage.setItem(STORAGE_ADVANCES, JSON.stringify(advances)); 
    render(); // Render after updating local state
    if(currentUser){
      await saveToFirestore(currentUser.uid); // Save both arrays to Firestore
    }
  }
  // ----------------------------------------------

  // --- Add/Update Entry Button Listener ---
  addBtn.addEventListener('click', async ()=>{
    const date = dateEl.value; const s = startEl.value; const e = endEl.value; const task = taskEl.value.trim();
    if(!date || !s || !e) return alert(translations[currentLang].alert_fill);
    const sM = parseHM(s), eM = parseHM(e); if(sM==null||eM==null) return alert('Invalid time');
    let diff = eM - sM; if(diff<0) diff += 24*60; 
    const formatted = fmtHM(diff); const rounded = computeRounded(diff);
    if(editId){ 
      const idx = entries.findIndex(x=>x.id===editId);
      if(idx>-1){ entries[idx] = { id: editId, date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false }; editId = null; addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; }
    } else { entries.push({ id: Date.now(), date, start: s, end: e, duration: formatted, rounded, task, isDayOff:false }); }
    formReset(); await saveAll(); 
  });
  // ----------------------------------------

  // --- Reset the entry input form ---
  function formReset(){ 
    dateEl.valueAsDate = new Date(selectedYear, selectedMonth, Math.min(new Date().getDate(),28)); 
    startEl.value=''; endEl.value=''; taskEl.value=''; 
    taskEl.placeholder = translations[currentLang].task_placeholder;
    previewEl.textContent = translations[currentLang].duration_default; 
    addBtn.textContent = '‚ûï ' + translations[currentLang].add_entry; 
    editId = null; 
  }
  // ----------------------------------

  // --- Add Day Off Button Listener ---
  dayOffBtn.addEventListener('click', async ()=>{
    const date = dateEl.value; if(!date) return alert(translations[currentLang].alert_fill);
    const dayOffText = translations[currentLang].day_off_text || 'Day Off';
    const existingDayOff = entries.some(x => x.date === date && x.isDayOff);
    if (existingDayOff) {
        entries = entries.filter(x => !(x.date === date && x.isDayOff));
        entries = entries.filter(x => x.date !== date); 
    } else {
        const regularEntries = entries.filter(x => x.date === date && !x.isDayOff);
        if (regularEntries.length > 0 && !confirm(`There are ${regularEntries.length} regular entries on ${date}. Do you want to delete them and mark this day as Day Off?`)) return;
        entries = entries.filter(x => x.date !== date);
        entries.push({ id: Date.now(), date, start:'', end:'', duration:'00:00', rounded:0, task: dayOffText, isDayOff:true });
    }
    formReset(); await saveAll(); 
  });
  // ---------------------------------

  // --- Unified Edit/Delete Listener (Event Delegation for BOTH tables) ---
  appContent.addEventListener('click', async (ev) => {
      // Handle Edit Entry
      if (ev.target.classList.contains('edit')) {
          const idStr = ev.target.getAttribute('data-id');
          if (!idStr) return;
          const id = Number(idStr);
          const idx = entries.findIndex(x => x.id === id);
          if (idx === -1) return;
          const r = entries[idx];
          if (r.isDayOff) return alert('Cannot edit Day Off');
          dateEl.value = r.date; startEl.value = r.start; endEl.value = r.end; taskEl.value = r.task;
          editId = id; addBtn.textContent = 'üíæ Save'; updatePreview();
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Handle Delete (Entry or Advance)
      if (ev.target.classList.contains('del')) {
          const idStr = ev.target.getAttribute('data-id');
          const type = ev.target.getAttribute('data-type'); // 'entry' or 'advance'
          if (!idStr || !type) return;
          if (!confirm('Delete this item?')) return;
          
          const id = Number(idStr);
          if (type === 'entry') {
              entries = entries.filter(x => x.id !== id);
          } else if (type === 'advance') {
              advances = advances.filter(x => x.id !== id);
          }
          await saveAll(); // Save changes for either type
      }
  });
  // -------------------------------------------------------------------

  // --- Export CSV Button Listener (No changes needed for advances yet) ---
  exportBtn.addEventListener('click', ()=>{
    const filtered = entries.filter(r=>{ const d=new Date(r.date); return d.getFullYear()===selectedYear && d.getMonth()===selectedMonth; });
    if(filtered.length===0) return alert('No data to export for this month');
    const t = translations['en']; const userName = currentUser ? currentUser.displayName || 'Unknown User' : 'Guest';
    const userLabel = translations[currentLang].csv_user_label || 'User Name';
    const totalEarnings = (parseFloat(totalEl.textContent) * HOURLY_RATE).toFixed(2);
    const currency = translations[currentLang].currency || '‡∏ø';
    const header=['Date','Start','End','Duration','Rounded Hours','Task'];
    let csv = `${userLabel}:,${userName}\n\n`; csv += header.join(',') + '\n';
    filtered.forEach(r=> csv += [r.date, r.isDayOff? 'Day Off': r.start, r.isDayOff? 'Day Off': r.end, r.isDayOff? 'Day Off': r.duration, r.isDayOff? '0.00': r.rounded.toFixed(2), `"${(r.task||'').replace(/"/g,'""')}"`].join(',') + '\n');
    csv += `\n${translations[currentLang].total_label},,, ,${totalEl.textContent}\n`;
    csv += `${translations[currentLang].earnings_label},,, ,${totalEarnings} ${currency}\n`; // Still shows gross
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `VannTrack_${userName.replace(/\s/g, '_')}_${selectedYear}-${String(selectedMonth+1).padStart(2,'0')}.csv`; document.body.appendChild(a); a.click(); a.remove();
  });
  // -----------------------------------------------------------------

  // --- Print Button Listener ---
  printBtn.addEventListener('click', ()=> window.print());
  // -----------------------------

  // --- Month Navigation Listeners ---
  prevMonthBtn.addEventListener('click', ()=>{ selectedMonth--; if(selectedMonth<0){ selectedMonth=11; selectedYear--; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  nextMonthBtn.addEventListener('click', ()=>{ selectedMonth++; if(selectedMonth>11){ selectedMonth=0; selectedYear++; } localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  todayMonthBtn.addEventListener('click', ()=>{ const now=new Date(); selectedYear=now.getFullYear(); selectedMonth=now.getMonth(); localStorage.setItem(MONTH, JSON.stringify({y:selectedYear,m:selectedMonth})); render(); });
  // ---------------------------------

  // --- Theme Toggle ---
  function applyTheme(){ 
    const t = localStorage.getItem(THEME) || 'dark'; 
    if(t==='light'){ document.body.classList.add('light-mode'); themeToggle.textContent='‚òÄÔ∏è'; } 
    else { document.body.classList.remove('light-mode'); themeToggle.textContent='üåô'; } 
  }
  themeToggle.addEventListener('click', ()=>{ 
    const now = document.body.classList.toggle('light-mode')? 'light':'dark'; 
    localStorage.setItem(THEME, now); applyTheme(); 
  });
  // -------------------

  // --- Language Switcher ---
  // Apply translated text to various UI elements (UPDATED)
  function applyLanguageTexts(){
    const t = translations[currentLang];
    const currency = t.currency || '‡∏ø';
    
    // Update main titles
    document.getElementById('app-title').textContent = t.app_title;
    document.getElementById('app-sub').textContent = t.sub;
    
    // Update Username Modal texts
    document.getElementById('modal-title').textContent = t.modal_title;
    document.getElementById('modal-subtitle').textContent = t.modal_subtitle;
    document.getElementById('save-username-btn').textContent = t.save_name;
    
    // Update Sign out button text
    signOutBtn.textContent = t.sign_out_btn;
    
    // Update Entry Input Labels
    dateLabel.textContent = t.date_label;
    startLabel.textContent = t.in_label;
    endLabel.textContent = t.out_label;
    taskLabel.textContent = t.task_placeholder;
    taskEl.placeholder = t.task_placeholder;
    
    // Update signed-in text (if user exists)
    if (currentUser && currentUser.displayName) {
        signedText.textContent = `Signed in: ${currentUser.displayName}`;
    }

    // Update Add/Save entry button text based on edit mode
    addBtn.textContent = editId ? 'üíæ Save' : '‚ûï ' + t.add_entry;
    
    // Update other button texts
    dayOffBtn.textContent = 'üèñÔ∏è ' + t.add_dayoff;
    exportBtn.textContent = 'üíæ ' + t.export_csv;
    printBtn.textContent = 'üñ®Ô∏è ' + t.print;
    
    // Update preview text if empty
    if (!startEl.value || !endEl.value) {
        previewEl.textContent = t.duration_default;
    }
    
    // Update Month Label 
    const localeCode = { en: 'en-US', my: 'my-MM', th: 'th-TH' }[currentLang] || 'en-US';
    monthLabel.textContent = new Date(selectedYear, selectedMonth, 1).toLocaleString(localeCode, { month: 'long', year: 'numeric' });
    
    // Update total hours label in header
    totalHeaderEl.innerHTML = `${t.total_label}: <span id="total">${totalEl.textContent}</span>`;
    
    // Update Advance Section Labels
    advanceTitle.textContent = t.advance_title;
    advanceDateLabel.textContent = t.advance_date_label;
    advanceAmountLabel.textContent = t.advance_amount_label;
    advanceNoteLabel.textContent = t.advance_note_label;
    advanceNoteEl.placeholder = t.advance_note_placeholder;
    addAdvanceBtn.textContent = '‚ûï ' + t.add_advance;

    // Update Table Headers
    thDate.textContent = t.th_date;
    thStart.textContent = t.th_start;
    thEnd.textContent = t.th_end;
    thDuration.textContent = t.th_duration;
    thRounded.textContent = t.th_rounded;
    thTask.textContent = t.th_task;
    thActions.textContent = t.th_actions;
    thAdvanceDate.textContent = t.th_advance_date;
    thAdvanceAmount.textContent = t.th_advance_amount;
    thAdvanceNote.textContent = t.th_advance_note;
    thAdvanceActions.textContent = t.th_advance_actions;
    
    // Re-calculate and display earnings (Gross, Advance, Net)
    updateEarningsDisplay(); 
  }
  
  // Language button click listener
  langButtons.addEventListener('click', (ev)=>{ 
    const b=ev.target; const lang=b.getAttribute('data-lang'); if(!lang) return; 
    currentLang = lang; localStorage.setItem(LANG,currentLang); 
    render(); // Re-render UI with new language
  });
  // -------------------------

  // --- Auth Tab Listeners ---
  tabSigninBtn.addEventListener('click', () => {
      tabSigninBtn.classList.add('active'); tabRegisterBtn.classList.remove('active');
      signinPane.style.display = 'block'; registerPane.style.display = 'none'; authMessageEl.textContent = '';
  });
  tabRegisterBtn.addEventListener('click', () => {
      tabSigninBtn.classList.remove('active'); tabRegisterBtn.classList.add('active');
      signinPane.style.display = 'none'; registerPane.style.display = 'block'; authMessageEl.textContent = '';
  });
  // -------------------------

  // --- Email/Password Login Logic ---
  loginBtn.addEventListener('click', async () => {
      const email = loginEmailEl.value.trim(); const password = loginPasswordEl.value;
      authMessageEl.style.color = 'var(--accent)'; authMessageEl.textContent = 'Signing in...';
      if (!email || !password) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Please enter email and password.'; return; }
      try { await signInWithEmailAndPassword(auth, email, password); authMessageEl.textContent = 'Sign in successful! Loading...'; } 
      catch (error) {
          authMessageEl.style.color = 'var(--danger)';
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { authMessageEl.textContent = 'Invalid email or password.'; } 
          else { console.error('Login Error:', error); authMessageEl.textContent = 'Error: ' + error.message; }
      }
  });
  // -------------------------------

  // --- Email/Password Registration Logic ---
  registerBtn.addEventListener('click', async () => {
      const username = registerUsernameEl.value.trim(); const email = registerEmailEl.value.trim(); const password = registerPasswordEl.value;
      authMessageEl.style.color = 'var(--accent)'; authMessageEl.textContent = 'Checking...';
      if (!username || !email || !password) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Please fill all fields.'; return; }
      if (password.length < 6) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Password must be at least 6 characters.'; return; }
      if (username.length < 3) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'Username must be at least 3 characters.'; return; }
      try {
          if (await isUsernameTaken(username)) { authMessageEl.style.color = 'var(--danger)'; authMessageEl.textContent = 'This username is already taken. Please try another.'; return; }
          authMessageEl.textContent = 'Creating account...';
          const userCredential = await createUserWithEmailAndPassword(auth, email, password); const user = userCredential.user;
          await updateProfile(user, { displayName: username }); await sendEmailVerification(user);
          const usernameRef = doc(db, 'usernames', username.toLowerCase()); await setDoc(usernameRef, { uid: user.uid });
          const userDocRef = doc(db, 'users', user.uid); await setDoc(userDocRef, { username: username, email: email, entries: [], advances: [] }, { merge: true }); // Initialize advances too
          authMessageEl.style.color = 'var(--success)'; authMessageEl.textContent = `Verification email sent to ${email}. Please check your inbox!`;
          tabSigninBtn.click(); registerUsernameEl.value = ''; registerEmailEl.value = ''; registerPasswordEl.value = '';
      } catch (error) {
          authMessageEl.style.color = 'var(--danger)';
          if (error.code === 'auth/email-already-in-use') { authMessageEl.textContent = 'This email is already registered. Please sign in.'; } 
          else if (error.code === 'auth/weak-password') { authMessageEl.textContent = 'Password is too weak.'; } 
          else { console.error('Registration Error:', error); authMessageEl.textContent = 'Error: ' + error.message; }
      }
  });
  // ----------------------------------------
  
  // --- Admin Panel Search Logic (Search by UID) ---
  adminSearchBtn.addEventListener('click', async () => {
        const searchUid = adminSearchInput.value.trim(); if (!searchUid) return; 
        adminResultsEl.style.display = 'block'; adminResultsEl.innerHTML = 'Searching...';
        try {
            const userRef = doc(db, 'users', searchUid); const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) { adminResultsEl.innerHTML = `Error: User data not found for UID: ${searchUid}`; return; }
            const userData = userSnap.data(); const userEntries = userData.entries || []; 
            let totalAllTimeHours = 0; userEntries.forEach(entry => { totalAllTimeHours += entry.rounded || 0; });
            adminResultsEl.innerHTML = `<strong>User:</strong> ${userData.username || 'N/A'}<br> <strong>Email:</strong> ${userData.email || 'N/A'}<br> <strong>Total Entries:</strong> ${userEntries.length}<br> <strong style="color: var(--earnings-color);">Total All-Time Rounded Hours:</strong> ${totalAllTimeHours.toFixed(2)}`;
        } catch (error) { console.error('Admin search error:', error); adminResultsEl.innerHTML = `Error: ${error.message}. (Is the UID correct? Did you update Firestore Rules?)`; }
    });
  // ---------------------------------------------

  // --- NEW: Add Advance Payment Button Listener ---
  addAdvanceBtn.addEventListener('click', async () => {
      const date = advanceDateEl.value;
      const amountStr = advanceAmountEl.value;
      const note = advanceNoteEl.value.trim();
      const t = translations[currentLang];

      // Validate date and amount
      if (!date || !amountStr) {
          return alert(t.alert_advance_fill);
      }
      const amount = parseFloat(amountStr);
      if (isNaN(amount) || amount <= 0) {
          return alert(t.alert_advance_amount);
      }

      // Add to advances array
      advances.push({
          id: Date.now(),
          date: date,
          amount: amount,
          note: note
      });

      // Clear form
      advanceDateEl.valueAsDate = new Date(selectedYear, selectedMonth, Math.min(new Date().getDate(), 28)); // Reset date
      advanceAmountEl.value = '';
      advanceNoteEl.value = '';

      // Save data
      await saveAll(); // saveAll now saves both entries and advances
  });
  // ---------------------------------------------

  // --- Initialize the application ---
  function init(){
    showLoadingState(); 
    loadLocal(); // Load entries AND advances
    const savedMonth = localStorage.getItem(MONTH);
    if(savedMonth){ try{ const o=JSON.parse(savedMonth); selectedYear=o.y; selectedMonth=o.m; }catch(e){} }
    if(typeof selectedYear==='undefined'){ const now=new Date(); selectedYear=now.getFullYear(); selectedMonth=now.getMonth(); }
    
    // Set initial date for both forms
    const initialDate = new Date(selectedYear, selectedMonth, Math.min(new Date().getDate(),28));
    dateEl.valueAsDate = initialDate;
    advanceDateEl.valueAsDate = initialDate; // Set advance date too
    
    // Load preferences
    currentLang = localStorage.getItem(LANG) || currentLang;
    applyTheme(); 
    isEarningsHidden = localStorage.getItem(EARNINGS_HIDDEN) === 'true'; 
    
    // Auth check will trigger the rest
  }
  init(); // Run initialization
  // ----------------------------------

  </script>
</body>
</html>
